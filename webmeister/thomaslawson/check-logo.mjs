import WebSocket from "ws"; import { get } from "http"; const getTargets = () => new Promise((resolve, reject) => { get("http://host.docker.internal:9222/json", { headers: { Host: "localhost" } }, (res) => { let data = ""; res.on("data", chunk => data += chunk); res.on("end", () => resolve(JSON.parse(data))); }).on("error", reject); }); const targets = await getTargets(); const tlPage = targets.find(t => t.url.includes("thomaslawson")); if (!tlPage) { console.log("No thomaslawson page found"); process.exit(1); } console.log("Found page:", tlPage.url); const ws = new WebSocket("ws://host.docker.internal:9222/devtools/page/" + tlPage.id, { headers: { Host: "localhost" } }); let id = 1; const send = (method, params = {}) => new Promise((resolve) => { const msgId = id++; ws.once("message", (data) => resolve(JSON.parse(data).result)); ws.send(JSON.stringify({ id: msgId, method, params })); }); ws.on("open", async () => { const result = await send("Runtime.evaluate", { expression: "JSON.stringify({brokenImages: Array.from(document.querySelectorAll(\"img\")).filter(i=>i.complete&&i.naturalWidth===0).map(i=>i.src), headerHTML: document.querySelector(\"header\")?.innerHTML.substring(0,800)})", returnByValue: true }); console.log(JSON.parse(result.result.value)); ws.close(); });
