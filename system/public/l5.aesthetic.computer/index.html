<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Try L5 on AC</title>
  <meta name="description" content="L5 (Processing-style Lua) compatibility board and live playground for Aesthetic Computer." />
  <link rel="icon" type="image/png" href="https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png" />
  <link rel="stylesheet" href="https://aesthetic.computer/type/webfonts/berkeley-mono-variable.css" />
  <style>
    @font-face {
      font-family: "YWFTProcessing-Regular";
      src: url("https://aesthetic.computer/type/webfonts/ywft-processing-regular.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      color-scheme: light dark;
      --bg: #ffffff;
      --ink: #111111;
      --ink-soft: #2b2b2b;
      --gold: #ffd700;
      --gold-soft: #ffee57;
      --line: #111111;
      --panel: rgba(255, 255, 255, 0.95);
      --control-bg: #ffffff;
      --head-bg: #ffee57;
      --code-bg: #000000;
      --code-ink: #ffd700;
      --dot-a: rgba(255, 215, 0, 0.32);
      --dot-b: rgba(255, 215, 0, 0.16);
      --ok: #127a3f;
      --warn: #8b5a00;
      --todo: #5a5a5a;
      --danger: #8f1f1f;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0a0a0a;
        --ink: #f4f4f4;
        --ink-soft: #c8c8c8;
        --gold: #f6d648;
        --gold-soft: #685b1b;
        --line: #f6d648;
        --panel: rgba(14, 14, 14, 0.92);
        --control-bg: #121212;
        --head-bg: #2a250a;
        --code-bg: #020202;
        --code-ink: #f6d648;
        --dot-a: rgba(246, 214, 72, 0.18);
        --dot-b: rgba(246, 214, 72, 0.09);
        --ok: #62d08e;
        --warn: #ffd26e;
        --todo: #bcbcbc;
        --danger: #ff9f9f;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Berkeley Mono Variable", Menlo, monospace;
      color: var(--ink);
      min-height: 100vh;
      background:
        radial-gradient(circle at 40% 40%, var(--dot-a) 11%, transparent 12%),
        radial-gradient(circle at 60% 60%, var(--dot-b) 11%, transparent 12%),
        var(--bg);
      background-size: 6em 6em;
      cursor: url("https://aesthetic.computer/aesthetic.computer/cursors/precise.svg") 12 12, auto;
      -webkit-text-size-adjust: none;
    }

    .wrap {
      max-width: 1220px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .panel {
      border: 2px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      padding: 14px;
      box-shadow: 0 3px 0 rgba(0, 0, 0, 0.12);
    }

    .hero {
      display: grid;
      gap: 12px;
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .logo-wrap {
      width: 74px;
      height: 74px;
      border-radius: 10px;
      border: 2px solid var(--line);
      background: radial-gradient(circle at 50% 50%, var(--gold-soft), var(--gold));
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    .logo-wrap img {
      width: 62px;
      height: auto;
      display: block;
    }

    h1 {
      font-family: "YWFTProcessing-Regular", "Berkeley Mono Variable", monospace;
      font-size: 36px;
      letter-spacing: 0.03em;
      font-weight: normal;
      line-height: 1;
    }

    .sub {
      color: var(--ink-soft);
      font-size: 13px;
      line-height: 1.5;
      max-width: 95ch;
    }

    .muted {
      color: var(--ink-soft);
      font-size: 12px;
      line-height: 1.45;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn,
    .btn:visited,
    button,
    select {
      text-decoration: none;
      color: var(--ink);
      border: 2px solid var(--line);
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      background: var(--control-bg);
      font: inherit;
    }

    button,
    select {
      cursor: pointer;
    }

    .btn:hover,
    button:hover {
      background: var(--gold);
      transform: translateY(-1px);
      transition: background-color 110ms linear, transform 110ms linear;
    }

    .btn-primary {
      background: var(--gold);
    }

    h2 {
      font-size: 13px;
      font-weight: normal;
      margin-bottom: 9px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-badge {
      display: inline-block;
      border: 1px solid currentColor;
      border-radius: 999px;
      padding: 1px 8px;
      font-size: 11px;
      margin-right: 4px;
      white-space: nowrap;
      background: var(--control-bg);
    }

    .status-done { color: var(--ok); }
    .status-in-progress { color: var(--warn); }
    .status-planned { color: var(--todo); }

    .checklist-host table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .checklist-host th,
    .checklist-host td {
      text-align: left;
      vertical-align: top;
      border: 1px solid var(--line);
      padding: 7px;
      line-height: 1.45;
      background: var(--control-bg);
    }

    .checklist-host th { background: var(--head-bg); }

    .checklist-host p {
      margin: 0 0 8px;
      color: var(--ink-soft);
      font-size: 12px;
    }

    .playground {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 1fr;
    }

    .editor-shell,
    .preview-shell {
      border: 2px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: var(--control-bg);
      min-height: 340px;
      display: flex;
      flex-direction: column;
    }

    .editor-head,
    .preview-head {
      padding: 6px 10px;
      border-bottom: 2px solid var(--line);
      background: var(--head-bg);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
    }

    #editor {
      width: 100%;
      flex: 1 1 auto;
      min-height: 280px;
      background: #060606;
    }

    .editor-fallback {
      border: 0;
      width: 100%;
      min-height: 280px;
      flex: 1 1 auto;
      padding: 10px;
      font-family: "Berkeley Mono Variable", Menlo, monospace;
      font-size: 12px;
      line-height: 1.45;
      background: #060606;
      color: var(--gold);
    }

    .preview-host {
      flex: 1 1 auto;
      min-height: 280px;
      background: #000;
      position: relative;
    }

    .preview-host iframe {
      border: 0;
      width: 100%;
      height: 100%;
      min-height: 280px;
      display: block;
      background: #000;
    }

    .runtime-status {
      border-top: 2px solid var(--line);
      padding: 5px 10px;
      font-size: 11px;
      color: var(--ink-soft);
      background: var(--control-bg);
    }

    .runtime-status.ok {
      color: var(--ok);
    }

    .runtime-status.error {
      color: var(--danger);
    }

    .doc-links {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .doc-links a,
    .doc-links a:visited {
      text-decoration: none;
      color: var(--ink);
      border: 2px solid var(--line);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      background: var(--gold);
    }

    .doc-links a:hover { background: #fff; }
    @media (prefers-color-scheme: dark) {
      .doc-links a:hover { background: var(--control-bg); }
    }

    @media (max-width: 820px) {
      .playground {
        grid-template-columns: 1fr;
      }
      .editor-shell { min-height: 300px; }
      .preview-shell { min-height: 280px; }
      #editor, .editor-fallback { min-height: 240px; }
      .preview-host, .preview-host iframe { min-height: 240px; }
    }

    .footer-wrap {
      max-width: 1220px;
      margin: 0 auto;
      padding: 0 16px 24px;
      display: grid;
      gap: 12px;
    }

    .footer-section h2 { margin-bottom: 12px; }

    .footer-credits {
      text-align: center;
      padding: 8px 0;
    }

    .footer-credits a {
      color: var(--ink-soft);
    }

    .checklist-details {
      margin-top: 12px;
    }

    .checklist-details summary {
      cursor: pointer;
      font-size: 12px;
      color: var(--ink-soft);
      padding: 6px 0;
    }

    @media (max-width: 700px) {
      .wrap { padding: 10px; }
      .footer-wrap { padding: 0 10px 16px; }
      .logo-wrap { width: 62px; height: 62px; }
      .logo-wrap img { width: 50px; }
      h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel hero">
      <div class="hero-top">
        <div class="brand">
          <div class="logo-wrap">
            <img id="brand-logo" src="https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png" alt="L5 logo" />
          </div>
          <div>
            <h1>Try L5 on AC</h1>
          </div>
        </div>
        <a class="btn" href="https://l5lua.org/" target="_blank" rel="noopener" title="Official L5 docs by l5lua.org">l5lua.org</a>
      </div>
    </section>

    <section class="panel">
      <div class="playground">
        <div class="editor-shell">
          <div class="editor-head">
            <div class="controls">
              <select id="example-select" aria-label="Choose example"></select>
              <a id="example-source" class="btn" href="https://l5lua.org/examples/" target="_blank" rel="noopener">Source</a>
              <button id="reset-btn" type="button">Reset</button>
              <button id="copy-btn" type="button">Copy</button>
              <button id="run-btn" class="btn-primary" type="button">Run</button>
            </div>
          </div>
          <div id="editor"></div>
        </div>

        <div class="preview-shell">
          <div class="preview-head">
            <a class="btn" href="https://aesthetic.computer/l5-hello.lua" target="_blank" rel="noopener">Open in AC</a>
          </div>
          <div class="preview-host">
            <iframe id="ac-frame" title="L5 runtime preview" loading="eager" allow="autoplay; clipboard-write"></iframe>
          </div>
          <div class="runtime-status" id="runtime-status">Booting AC iframe...</div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px;">
        Live reload on edit. <code>Cmd/Ctrl+Enter</code> to force run. Zoom: <code>Cmd/Ctrl +/-/0</code> in editor.
      </p>
    </section>

  </main>

  <footer class="footer-wrap">
    <section class="panel footer-section">
      <h2>AC Runtime Integration</h2>
      <div class="doc-links" id="doc-links"></div>
      <details class="checklist-details">
        <summary>Checklist</summary>
        <div class="checklist-host" id="checklist-host">
          <p>Loading checklist...</p>
        </div>
      </details>
    </section>
    <div class="footer-credits muted">
      <a href="https://l5lua.org/" target="_blank" rel="noopener">L5</a> by the L5 community &middot;
      Runtime integration by <a href="https://aesthetic.computer" target="_blank" rel="noopener">Aesthetic Computer</a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/loader.min.js"></script>
  <script>
    const DOCS_JSON_URL = "https://aesthetic.computer/docs.json";
    const AC_ORIGIN = "https://aesthetic.computer";
    const FRAME_SRC = `${AC_ORIGIN}/l5-hello.lua?nogap=true&nolabel=true&noauth=true&popout=true&t=${Date.now()}`;

    const EXAMPLES = [
      {
        id: "pulse",
        title: "Pulse Circle",
        code: `function setup()\n  size(256, 256)\nend\n\nfunction draw()\n  background(12, 12, 18)\n  local r = 40 + math.sin(frameCount * 0.05) * 20\n  fill(255, 120, 80)\n  circle(width / 2, height / 2, r * 2)\nend`,
      },
      {
        id: "mouse",
        title: "Mouse Dots",
        code: `function setup()\n  background(255)\nend\n\nfunction draw()\n  if mouseIsPressed then\n    fill(20, 20, 20)\n    circle(mouseX, mouseY, 10)\n  end\nend`,
      },
      {
        id: "grid",
        title: "Grid Drift",
        code: `function setup()\n  size(256, 256)\nend\n\nfunction draw()\n  background(245)\n  stroke(0)\n  noFill()\n  for y = 16, height - 16, 16 do\n    for x = 16, width - 16, 16 do\n      local wobble = math.sin((x + y + frameCount) * 0.04) * 3\n      circle(x + wobble, y, 6)\n    end\n  end\nend`,
      },
      {
        id: "hello",
        title: "L5 Hello",
        code: `function setup()\n  size(256, 256)\n  noStroke()\nend\n\nfunction draw()\n  background(16, 16, 24)\n\n  local pulse = 48 + math.sin(frameCount * 0.05) * 18\n  fill(255, 190, 0)\n  circle(width / 2, height / 2, pulse * 2)\n\n  fill(255, 255, 255)\n  text("L5 -> AC", 16, 22)\n\n  if mouseIsPressed then\n    fill(255, 255, 255)\n    circle(mouseX, mouseY, 10)\n  end\nend`,
      },
      {
        id: "l5-shapes",
        title: "Shape Primitives (L5)",
        sourceUrl: "https://l5lua.org/examples/shapes-and-color-shape-primitives/",
        code: `function setup()\n  size(720, 400)\nend\n\nfunction draw()\n  background(220)\n\n  square(20, 20, 100)\n  rect(100, 40, 200, 100)\n\n  ellipse(540, 100, 300, 100)\n  circle(560, 100, 100)\n\n  line(20, 200, 200, 350)\n  triangle(250, 350, 350, 200, 450, 350)\n  quad(500, 250, 550, 200, 700, 300, 650, 350)\n\n  noLoop()\nend`,
      },
      {
        id: "l5-doodle",
        title: "Doodle Draw (L5)",
        sourceUrl: "https://l5lua.org/examples/doodle-draw/",
        code: `function setup()\n  size(800, 600)\n  background(20, 24, 60)\n  strokeWeight(5)\nend\n\nfunction mouseDragged()\n  line(mouseX, mouseY, pmouseX, pmouseY)\nend\n\nfunction mousePressed()\n  stroke(random(255), random(255), random(255))\nend`,
      },
      {
        id: "l5-10print",
        title: "10 Print (L5)",
        sourceUrl: "https://l5lua.org/examples/10print/",
        code: `local block = 20\n\nfunction setup()\n  size(600, 600)\n  frameRate(1)\nend\n\nfunction draw()\n  background(255)\n  block = math.floor(random(10, 140))\n  if block < 8 then block = 8 end\n\n  for y = 1, height, block do\n    for x = 1, width, block do\n      if random() < 0.5 then\n        line(x, y, x + block, y + block)\n      else\n        line(x + block, y, x, y + block)\n      end\n    end\n  end\nend`,
      },
      {
        id: "l5-events",
        title: "Animation Events (L5)",
        sourceUrl: "https://l5lua.org/examples/animation-and-variables-animation-with-events/",
        code: `local x = 25\n\nfunction setup()\n  size(720, 400)\n  textSize(20)\n  noLoop()\nend\n\nfunction draw()\n  background(0)\n  fill((x / 3) % 255, 90, 90)\n  circle(x, height / 2, 50)\n\n  x = x + 5\n  if x > width + 25 then\n    x = -25\n  end\nend\n\nfunction mousePressed()\n  if isLooping() then\n    noLoop()\n  else\n    loop()\n  end\nend\n\nfunction keyPressed()\n  redraw()\nend`,
      },
      {
        id: "l5-conditions",
        title: "Conditions (L5)",
        sourceUrl: "https://l5lua.org/examples/animation-and-variables-conditions/",
        code: `local x = 200\nlocal y = 200\nlocal vx = 2\nlocal vy = 3\nlocal radius = 25\nlocal hue = 0\n\nfunction setup()\n  size(400, 400)\n  background(255)\n\n  noStroke()\n  fill(128)\n  rect(0, 0, 100, height)\n  rect(300, 0, 100, height)\n\n  strokeWeight(4)\nend\n\nfunction draw()\n  stroke(hue, 80, 200)\n\n  if x >= 100 and x <= 300 then\n    fill(0)\n  else\n    fill(255)\n  end\n\n  circle(x, y, radius * 2)\n\n  if mouseIsPressed then\n    x = x + vx\n    y = y + vy\n    hue = (hue + 1) % 255\n  end\n\n  if x < radius or x > width - radius then\n    vx = -vx\n  end\n\n  if y < radius or y > height - radius then\n    vy = -vy\n  end\nend`,
      },
    ];

    const state = {
      editor: null,
      fallbackEditor: null,
      iframeReady: false,
      pendingCode: null,
      selectedExampleId: EXAMPLES[0].id,
      monacoReady: false,
    };

    const runtimeStatus = document.getElementById("runtime-status");

    function setRuntimeStatus(message, level = "") {
      runtimeStatus.textContent = message;
      runtimeStatus.classList.remove("ok", "error");
      if (level) runtimeStatus.classList.add(level);
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function getExampleById(id) {
      return EXAMPLES.find((item) => item.id === id) || EXAMPLES[0];
    }

    function getEditorValue() {
      if (state.editor) return state.editor.getValue();
      if (state.fallbackEditor) return state.fallbackEditor.value;
      return "";
    }

    function setEditorValue(value) {
      if (state.editor) {
        state.editor.setValue(value);
      } else if (state.fallbackEditor) {
        state.fallbackEditor.value = value;
      }
    }

    function sendLuaToIframe(code) {
      const frame = document.getElementById("ac-frame");
      if (!frame.contentWindow) {
        setRuntimeStatus("AC iframe unavailable.", "error");
        return;
      }
      frame.contentWindow.postMessage(
        {
          type: "l5-reload",
          code,
          ext: "lua",
          liveName: "l5-live",
        },
        AC_ORIGIN,
      );
      setRuntimeStatus("Lua sent to AC runtime.", "ok");
    }

    function queueOrRun(code) {
      if (!code || !code.trim()) {
        setRuntimeStatus("Cannot run empty Lua source.", "error");
        return;
      }
      if (!state.iframeReady) {
        state.pendingCode = code;
        setRuntimeStatus("Iframe not ready yet. Code queued...", "");
        return;
      }
      sendLuaToIframe(code);
    }

    function initExampleControls() {
      const select = document.getElementById("example-select");
      const source = document.getElementById("example-source");
      const resetBtn = document.getElementById("reset-btn");
      const copyBtn = document.getElementById("copy-btn");
      const runBtn = document.getElementById("run-btn");

      const updateSource = (picked) => {
        source.href = picked.sourceUrl || "https://l5lua.org/examples/";
        source.textContent = picked.sourceUrl ? "L5 Source" : "Source";
      };

      select.innerHTML = EXAMPLES
        .map((item) => `<option value="${item.id}">${escapeHtml(item.title)}</option>`)
        .join("");
      select.value = state.selectedExampleId;
      updateSource(getExampleById(state.selectedExampleId));

      select.addEventListener("change", () => {
        state.selectedExampleId = select.value;
        const picked = getExampleById(state.selectedExampleId);
        updateSource(picked);
        setEditorValue(picked.code);
      });

      resetBtn.addEventListener("click", () => {
        const picked = getExampleById(state.selectedExampleId);
        setEditorValue(picked.code);
        setRuntimeStatus(`Reset to ${picked.title}.`, "");
      });

      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(getEditorValue());
          const old = copyBtn.textContent;
          copyBtn.textContent = "Copied";
          setTimeout(() => {
            copyBtn.textContent = old;
          }, 900);
        } catch (_err) {
          setRuntimeStatus("Clipboard write failed.", "error");
        }
      });

      runBtn.addEventListener("click", () => {
        queueOrRun(getEditorValue());
      });

      window.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          queueOrRun(getEditorValue());
        }
      });
    }

    function initMonacoEditor() {
      const container = document.getElementById("editor");
      const initial = getExampleById(state.selectedExampleId).code;

      if (!window.require) {
        const textarea = document.createElement("textarea");
        textarea.className = "editor-fallback";
        textarea.value = initial;
        container.replaceWith(textarea);
        state.fallbackEditor = textarea;
        setRuntimeStatus("Monaco unavailable. Using fallback editor.", "error");
        return;
      }

      const workerCode = `self.MonacoEnvironment={baseUrl:'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/'};importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/base/worker/workerMain.js');`;
      const workerBlob = new Blob([workerCode], { type: "application/javascript" });
      const workerUrl = URL.createObjectURL(workerBlob);

      window.MonacoEnvironment = {
        getWorkerUrl: () => workerUrl,
      };

      window.require.config({
        paths: {
          vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs",
        },
      });

      window.require(["vs/editor/editor.main"], () => {
        monaco.editor.defineTheme("l5-yellow-dark", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "keyword", foreground: "ffd700" },
            { token: "identifier", foreground: "f6f6f6" },
            { token: "comment", foreground: "999999" },
            { token: "string", foreground: "ffee57" },
          ],
          colors: {
            "editor.background": "#060606",
            "editor.foreground": "#f6f6f6",
            "editorCursor.foreground": "#ffd700",
            "editor.lineHighlightBackground": "#111111",
            "editorLineNumber.foreground": "#666666",
            "editorLineNumber.activeForeground": "#ffd700",
            "editor.selectionBackground": "#ffd70033",
          },
        });

        monaco.editor.defineTheme("l5-yellow-light", {
          base: "vs",
          inherit: true,
          rules: [
            { token: "keyword", foreground: "8b6500" },
            { token: "identifier", foreground: "1a1a1a" },
            { token: "comment", foreground: "6c6c6c" },
            { token: "string", foreground: "945f00" },
          ],
          colors: {
            "editor.background": "#fffdf2",
            "editor.foreground": "#111111",
            "editorCursor.foreground": "#111111",
            "editor.lineHighlightBackground": "#fff6cf",
            "editorLineNumber.foreground": "#8f8f8f",
            "editorLineNumber.activeForeground": "#8b6500",
            "editor.selectionBackground": "#f6d64844",
          },
        });

        const applyEditorTheme = () => {
          const isDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          monaco.editor.setTheme(isDark ? "l5-yellow-dark" : "l5-yellow-light");
        };

        state.editor = monaco.editor.create(container, {
          value: initial,
          language: "lua",
          theme: "l5-yellow-dark",
          minimap: { enabled: false },
          automaticLayout: true,
          tabSize: 2,
          insertSpaces: true,
          fontFamily: "Berkeley Mono Variable, Menlo, monospace",
          fontSize: 13,
          lineHeight: 20,
          scrollBeyondLastLine: false,
        });

        applyEditorTheme();
        if (window.matchMedia) {
          window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", applyEditorTheme);
        }

        // Editor-scoped zoom (Cmd/Ctrl + Plus/Minus/0) â€” prevents page zoom
        let editorFontSize = 13;
        const EDITOR_FONT_MIN = 8;
        const EDITOR_FONT_MAX = 32;
        const EDITOR_FONT_DEFAULT = 13;

        state.editor.onKeyDown((e) => {
          const isMeta = e.metaKey || e.ctrlKey;
          if (!isMeta) return;
          const isPlus = e.keyCode === monaco.KeyCode.Equal || e.keyCode === monaco.KeyCode.NumpadAdd;
          const isMinus = e.keyCode === monaco.KeyCode.Minus || e.keyCode === monaco.KeyCode.NumpadSubtract;
          const isZero = e.keyCode === monaco.KeyCode.Digit0 || e.keyCode === monaco.KeyCode.Numpad0;
          if (isPlus || isMinus || isZero) {
            e.preventDefault();
            e.stopPropagation();
            if (isPlus && editorFontSize < EDITOR_FONT_MAX) editorFontSize += 2;
            else if (isMinus && editorFontSize > EDITOR_FONT_MIN) editorFontSize -= 2;
            else if (isZero) editorFontSize = EDITOR_FONT_DEFAULT;
            state.editor.updateOptions({ fontSize: editorFontSize });
          }
        });

        // Live reload: send code to preview on every edit (debounced)
        let liveTimer = null;
        state.editor.onDidChangeModelContent(() => {
          clearTimeout(liveTimer);
          liveTimer = setTimeout(() => {
            queueOrRun(state.editor.getValue());
          }, 400);
        });

        state.monacoReady = true;
      });
    }

    function initIframeRunner() {
      const frame = document.getElementById("ac-frame");

      frame.addEventListener("load", () => {
        setRuntimeStatus("AC iframe loaded. Waiting for runtime ready signal...", "");
      });

      window.addEventListener("message", (event) => {
        if (event.origin !== AC_ORIGIN) return;
        const type = event.data?.type;
        if (type === "ready" || type === "kidlisp-ready") {
          state.iframeReady = true;
          setRuntimeStatus("AC runtime ready.", "ok");
          if (state.pendingCode) {
            sendLuaToIframe(state.pendingCode);
            state.pendingCode = null;
          }
        }
      });

      frame.src = FRAME_SRC;
    }

    async function loadDocsBackedContent() {
      const host = document.getElementById("checklist-host");
      const links = document.getElementById("doc-links");

      try {
        const res = await fetch(DOCS_JSON_URL, { cache: "no-store" });
        const raw = await res.text();
        let docs;

        try {
          docs = JSON.parse(raw);
        } catch (_err) {
          throw new Error(`Unexpected non-JSON response from docs endpoint (status ${res.status}).`);
        }

        if (!res.ok) {
          throw new Error(`Docs fetch failed with status ${res.status}.`);
        }

        const l5 = docs?.api?.l5 || {};

        if (l5.checklist?.body) {
          host.innerHTML = l5.checklist.body;
        } else {
          host.innerHTML = "<p>Checklist not found in docs data.</p>";
        }

        const keys = Object.keys(l5).sort((a, b) => a.localeCompare(b));
        links.innerHTML = keys
          .map((key) => `<a href=\"${AC_ORIGIN}/docs/l5:${key}\">${escapeHtml(key)}</a>`)
          .join("");

      } catch (err) {
        host.innerHTML = `<p>Could not load checklist: ${escapeHtml(String(err.message || err))}</p>`;
        links.innerHTML = "";
      }
    }

    function initLogoFallback() {
      const img = document.getElementById("brand-logo");
      img.addEventListener("error", () => {
        img.src = "https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png";
      }, { once: true });
    }

    initLogoFallback();
    initExampleControls();
    initMonacoEditor();
    initIframeRunner();
    loadDocsBackedContent();
  </script>
</body>
</html>
