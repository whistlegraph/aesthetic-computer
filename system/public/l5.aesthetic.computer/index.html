<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Try L5 on AC</title>
  <meta name="description" content="L5 (Processing-style Lua) live playground and API explorer for Aesthetic Computer." />
  <link rel="icon" type="image/png" href="https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png" />
  <link rel="stylesheet" href="https://aesthetic.computer/type/webfonts/berkeley-mono-variable.css" />
  <style>
    @font-face {
      font-family: "YWFTProcessing-Regular";
      src: url("https://aesthetic.computer/type/webfonts/ywft-processing-regular.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      color-scheme: light dark;
      --bg: #ffffff;
      --ink: #111111;
      --ink-soft: #2b2b2b;
      --gold: #ffd700;
      --gold-soft: #ffee57;
      --line: #111111;
      --panel: rgba(255, 255, 255, 0.95);
      --control-bg: #ffffff;
      --head-bg: #ffee57;
      --code-bg: #000000;
      --code-ink: #ffd700;
      --dot-a: rgba(255, 215, 0, 0.32);
      --dot-b: rgba(255, 215, 0, 0.16);
      --ok: #127a3f;
      --warn: #8b5a00;
      --todo: #5a5a5a;
      --danger: #8f1f1f;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0a0a0a;
        --ink: #f4f4f4;
        --ink-soft: #c8c8c8;
        --gold: #f6d648;
        --gold-soft: #685b1b;
        --line: #f6d648;
        --panel: rgba(14, 14, 14, 0.92);
        --control-bg: #121212;
        --head-bg: #2a250a;
        --code-bg: #020202;
        --code-ink: #f6d648;
        --dot-a: rgba(246, 214, 72, 0.18);
        --dot-b: rgba(246, 214, 72, 0.09);
        --ok: #62d08e;
        --warn: #ffd26e;
        --todo: #bcbcbc;
        --danger: #ff9f9f;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Berkeley Mono Variable", Menlo, monospace;
      color: var(--ink);
      min-height: 100vh;
      background:
        radial-gradient(circle at 40% 40%, var(--dot-a) 11%, transparent 12%),
        radial-gradient(circle at 60% 60%, var(--dot-b) 11%, transparent 12%),
        var(--bg);
      background-size: 6em 6em;
      cursor: url("https://aesthetic.computer/aesthetic.computer/cursors/precise.svg") 12 12, auto;
      -webkit-text-size-adjust: none;
    }

    .wrap {
      max-width: 1220px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      padding: 12px;
    }

    .hero {
      display: grid;
      gap: 12px;
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .logo-wrap {
      width: 74px;
      height: 74px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: radial-gradient(circle at 50% 50%, var(--gold-soft), var(--gold));
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    .logo-wrap img {
      width: 62px;
      height: auto;
      display: block;
    }

    h1 {
      font-family: "YWFTProcessing-Regular", "Berkeley Mono Variable", monospace;
      font-size: 36px;
      letter-spacing: 0.03em;
      font-weight: normal;
      line-height: 1;
    }

    .sub {
      color: var(--ink-soft);
      font-size: 13px;
      line-height: 1.5;
      max-width: 95ch;
    }

    .muted {
      color: var(--ink-soft);
      font-size: 12px;
      line-height: 1.45;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn,
    .btn:visited,
    button,
    select {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 11px;
      font-size: 12px;
      background: var(--control-bg);
      font: inherit;
    }

    button,
    select {
      cursor: pointer;
    }

    .btn:hover,
    button:hover {
      background: var(--gold);
      transform: translateY(-1px);
      transition: background-color 110ms linear, transform 110ms linear;
    }

    .btn-primary {
      background: var(--gold);
    }

    h2 {
      font-size: 13px;
      font-weight: normal;
      margin-bottom: 9px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .doc-panel {
      border-top: 1px solid var(--line);
      padding: 6px 10px;
      font-size: 12px;
      line-height: 1.45;
      color: var(--ink-soft);
      background: var(--control-bg);
      min-height: 28px;
      display: flex;
      gap: 12px;
      align-items: baseline;
      grid-column: 1 / -1;
    }

    .doc-panel .doc-sig {
      color: var(--gold);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .doc-panel .doc-cat {
      color: var(--ink-soft);
      font-size: 11px;
      opacity: 0.7;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .doc-panel .doc-desc {
      color: var(--ink);
    }

    .playground {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: var(--control-bg);
      min-height: 380px;
    }

    .editor-shell {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--line);
      min-height: 0;
    }

    .preview-shell {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .editor-head,
    .preview-head {
      padding: 5px 10px;
      border-bottom: 1px solid var(--line);
      background: var(--head-bg);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
    }

    #editor {
      width: 100%;
      flex: 1 1 auto;
      min-height: 280px;
      background: #060606;
    }

    .editor-fallback {
      border: 0;
      width: 100%;
      min-height: 280px;
      flex: 1 1 auto;
      padding: 10px;
      font-family: "Berkeley Mono Variable", Menlo, monospace;
      font-size: 12px;
      line-height: 1.45;
      background: #060606;
      color: var(--gold);
    }

    .preview-host {
      flex: 1 1 auto;
      min-height: 280px;
      background: #000;
      position: relative;
    }

    .preview-host iframe {
      border: 0;
      width: 100%;
      height: 100%;
      min-height: 280px;
      display: block;
      background: #000;
    }

    .runtime-status {
      border-top: 1px solid var(--line);
      padding: 5px 10px;
      font-size: 11px;
      color: var(--ink-soft);
      background: var(--control-bg);
    }

    .runtime-status.ok {
      color: var(--ok);
    }

    .runtime-status.error {
      color: var(--danger);
    }


    @media (max-width: 820px) {
      .playground {
        grid-template-columns: 1fr;
      }
      .editor-shell {
        border-right: none;
        border-bottom: 1px solid var(--line);
        min-height: 300px;
      }
      .preview-shell { min-height: 280px; }
      #editor, .editor-fallback { min-height: 240px; }
      .preview-host, .preview-host iframe { min-height: 240px; }
    }

    .footer-wrap {
      max-width: 1220px;
      margin: 0 auto;
      padding: 0 16px 16px;
    }

    .footer-credits {
      text-align: center;
      padding: 8px 0;
    }

    .footer-credits a {
      color: var(--ink-soft);
    }

    @media (max-width: 700px) {
      .wrap { padding: 10px; }
      .footer-wrap { padding: 0 10px 10px; }
      .logo-wrap { width: 62px; height: 62px; }
      .logo-wrap img { width: 50px; }
      h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel hero">
      <div class="hero-top">
        <div class="brand">
          <div class="logo-wrap">
            <img id="brand-logo" src="https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png" alt="L5 logo" />
          </div>
          <div>
            <h1>Try L5 on AC</h1>
          </div>
        </div>
        <a class="btn" href="https://l5lua.org/" target="_blank" rel="noopener" title="Official L5 docs by l5lua.org">l5lua.org</a>
      </div>
    </section>

    <section class="playground">
      <div class="editor-shell">
        <div class="editor-head">
          <div class="controls">
            <select id="example-select" aria-label="Choose example"></select>
            <a id="example-source" class="btn" href="https://l5lua.org/examples/" target="_blank" rel="noopener">Source</a>
            <button id="reset-btn" type="button">Reset</button>
            <button id="copy-btn" type="button">Copy</button>
            <button id="run-btn" class="btn-primary" type="button">Run</button>
          </div>
        </div>
        <div id="editor"></div>
      </div>

      <div class="preview-shell">
        <div class="preview-head">
          <a class="btn" href="https://aesthetic.computer/l5-hello.lua" target="_blank" rel="noopener">Open in AC</a>
        </div>
        <div class="preview-host">
          <iframe id="ac-frame" title="L5 runtime preview" loading="eager" allow="autoplay; clipboard-write"></iframe>
        </div>
        <div class="runtime-status" id="runtime-status">Booting AC iframe...</div>
      </div>
      <div class="doc-panel" id="doc-panel">Hover over a function to see its docs.</div>
    </section>

    <p class="muted" style="padding: 0 2px;">
      Live reload on edit. <code>Cmd/Ctrl+Enter</code> to force run. Zoom: <code>Cmd/Ctrl +/-/0</code> in editor.
    </p>

  </main>

  <footer class="footer-wrap">
    <div class="footer-credits muted">
      <a href="https://l5lua.org/" target="_blank" rel="noopener">L5</a> by the L5 community &middot;
      <a href="https://aesthetic.computer" target="_blank" rel="noopener">Aesthetic Computer</a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/loader.min.js"></script>
  <script>
    const AC_ORIGIN = "https://aesthetic.computer";
    const FRAME_SRC = `${AC_ORIGIN}/l5-hello.lua?nogap=true&nolabel=true&noauth=true&popout=true&t=${Date.now()}`;

    const EXAMPLES = [
      {
        id: "pulse",
        title: "Pulse Circle",
        code: `function setup()\n  size(256, 256)\nend\n\nfunction draw()\n  background(12, 12, 18)\n  local r = 40 + math.sin(frameCount * 0.05) * 20\n  fill(255, 120, 80)\n  circle(width / 2, height / 2, r * 2)\nend`,
      },
      {
        id: "mouse",
        title: "Mouse Dots",
        code: `function setup()\n  background(255)\nend\n\nfunction draw()\n  if mouseIsPressed then\n    fill(20, 20, 20)\n    circle(mouseX, mouseY, 10)\n  end\nend`,
      },
      {
        id: "grid",
        title: "Grid Drift",
        code: `function setup()\n  size(256, 256)\nend\n\nfunction draw()\n  background(245)\n  stroke(0)\n  noFill()\n  for y = 16, height - 16, 16 do\n    for x = 16, width - 16, 16 do\n      local wobble = math.sin((x + y + frameCount) * 0.04) * 3\n      circle(x + wobble, y, 6)\n    end\n  end\nend`,
      },
      {
        id: "hello",
        title: "L5 Hello",
        code: `function setup()\n  size(256, 256)\n  noStroke()\nend\n\nfunction draw()\n  background(16, 16, 24)\n\n  local pulse = 48 + math.sin(frameCount * 0.05) * 18\n  fill(255, 190, 0)\n  circle(width / 2, height / 2, pulse * 2)\n\n  fill(255, 255, 255)\n  text("L5 -> AC", 16, 22)\n\n  if mouseIsPressed then\n    fill(255, 255, 255)\n    circle(mouseX, mouseY, 10)\n  end\nend`,
      },
      {
        id: "l5-shapes",
        title: "Shape Primitives (L5)",
        sourceUrl: "https://l5lua.org/examples/shapes-and-color-shape-primitives/",
        code: `function setup()\n  size(720, 400)\nend\n\nfunction draw()\n  background(220)\n\n  square(20, 20, 100)\n  rect(100, 40, 200, 100)\n\n  ellipse(540, 100, 300, 100)\n  circle(560, 100, 100)\n\n  line(20, 200, 200, 350)\n  triangle(250, 350, 350, 200, 450, 350)\n  quad(500, 250, 550, 200, 700, 300, 650, 350)\n\n  noLoop()\nend`,
      },
      {
        id: "l5-doodle",
        title: "Doodle Draw (L5)",
        sourceUrl: "https://l5lua.org/examples/doodle-draw/",
        code: `function setup()\n  size(800, 600)\n  background(20, 24, 60)\n  strokeWeight(5)\nend\n\nfunction mouseDragged()\n  line(mouseX, mouseY, pmouseX, pmouseY)\nend\n\nfunction mousePressed()\n  stroke(random(255), random(255), random(255))\nend`,
      },
      {
        id: "l5-10print",
        title: "10 Print (L5)",
        sourceUrl: "https://l5lua.org/examples/10print/",
        code: `local block = 20\n\nfunction setup()\n  size(600, 600)\n  frameRate(1)\nend\n\nfunction draw()\n  background(255)\n  block = math.floor(random(10, 140))\n  if block < 8 then block = 8 end\n\n  for y = 1, height, block do\n    for x = 1, width, block do\n      if random() < 0.5 then\n        line(x, y, x + block, y + block)\n      else\n        line(x + block, y, x, y + block)\n      end\n    end\n  end\nend`,
      },
      {
        id: "l5-events",
        title: "Animation Events (L5)",
        sourceUrl: "https://l5lua.org/examples/animation-and-variables-animation-with-events/",
        code: `local x = 25\n\nfunction setup()\n  size(720, 400)\n  textSize(20)\n  noLoop()\nend\n\nfunction draw()\n  background(0)\n  fill((x / 3) % 255, 90, 90)\n  circle(x, height / 2, 50)\n\n  x = x + 5\n  if x > width + 25 then\n    x = -25\n  end\nend\n\nfunction mousePressed()\n  if isLooping() then\n    noLoop()\n  else\n    loop()\n  end\nend\n\nfunction keyPressed()\n  redraw()\nend`,
      },
      {
        id: "l5-conditions",
        title: "Conditions (L5)",
        sourceUrl: "https://l5lua.org/examples/animation-and-variables-conditions/",
        code: `local x = 200\nlocal y = 200\nlocal vx = 2\nlocal vy = 3\nlocal radius = 25\nlocal hue = 0\n\nfunction setup()\n  size(400, 400)\n  background(255)\n\n  noStroke()\n  fill(128)\n  rect(0, 0, 100, height)\n  rect(300, 0, 100, height)\n\n  strokeWeight(4)\nend\n\nfunction draw()\n  stroke(hue, 80, 200)\n\n  if x >= 100 and x <= 300 then\n    fill(0)\n  else\n    fill(255)\n  end\n\n  circle(x, y, radius * 2)\n\n  if mouseIsPressed then\n    x = x + vx\n    y = y + vy\n    hue = (hue + 1) % 255\n  end\n\n  if x < radius or x > width - radius then\n    vx = -vx\n  end\n\n  if y < radius or y > height - radius then\n    vy = -vy\n  end\nend`,
      },
    ];

    // L5 API reference — keyed by identifier
    const L5_DOCS = {
      // Lifecycle
      setup:          { sig: "function setup()", desc: "Called once when the sketch starts. Use for initialization, size(), and initial state.", cat: "Lifecycle" },
      draw:           { sig: "function draw()", desc: "Called every frame. Put your rendering and animation logic here.", cat: "Lifecycle" },
      keyPressed:     { sig: "function keyPressed()", desc: "Called once when a key is pressed. Use `key` and `keyCode` globals to read which key.", cat: "Lifecycle" },
      keyReleased:    { sig: "function keyReleased()", desc: "Called once when a key is released.", cat: "Lifecycle" },
      mousePressed:   { sig: "function mousePressed()", desc: "Called once when the mouse button or touch is pressed.", cat: "Lifecycle" },
      mouseReleased:  { sig: "function mouseReleased()", desc: "Called once when the mouse button or touch is released.", cat: "Lifecycle" },
      mouseMoved:     { sig: "function mouseMoved()", desc: "Called when the mouse moves without a button pressed.", cat: "Lifecycle" },
      mouseDragged:   { sig: "function mouseDragged()", desc: "Called when the mouse moves with a button pressed.", cat: "Lifecycle" },

      // Canvas
      size:           { sig: "size(w, h?)", desc: "Set the sketch resolution. Call in setup(). Height defaults to width if omitted.", cat: "Canvas" },
      background:     { sig: "background(r, g?, b?, a?)", desc: "Clear the canvas with a color. Single arg = grayscale. Three args = RGB.", cat: "Graphics" },
      clear:          { sig: "clear()", desc: "Clear the canvas to transparent black.", cat: "Graphics" },

      // Color & style
      fill:           { sig: "fill(r, g?, b?, a?)", desc: "Set the fill color for subsequent shapes. Single arg = grayscale.", cat: "Graphics" },
      noFill:         { sig: "noFill()", desc: "Disable fill for subsequent shapes (outline only).", cat: "Graphics" },
      stroke:         { sig: "stroke(r, g?, b?, a?)", desc: "Set the stroke (outline) color for subsequent shapes.", cat: "Graphics" },
      noStroke:       { sig: "noStroke()", desc: "Disable stroke for subsequent shapes (fill only).", cat: "Graphics" },
      strokeWeight:   { sig: "strokeWeight(weight)", desc: "Set the thickness of lines and shape outlines in pixels.", cat: "Graphics" },

      // Shape primitives
      point:          { sig: "point(x, y)", desc: "Draw a single pixel at (x, y).", cat: "Graphics" },
      line:           { sig: "line(x1, y1, x2, y2)", desc: "Draw a line between two points.", cat: "Graphics" },
      rect:           { sig: "rect(x, y, w, h)", desc: "Draw a rectangle. (x, y) is the top-left corner.", cat: "Graphics" },
      square:         { sig: "square(x, y, size)", desc: "Draw a square. Shorthand for rect(x, y, size, size).", cat: "Graphics" },
      circle:         { sig: "circle(x, y, diameter)", desc: "Draw a circle centered at (x, y) with the given diameter.", cat: "Graphics" },
      ellipse:        { sig: "ellipse(x, y, w, h)", desc: "Draw an ellipse centered at (x, y).", cat: "Graphics" },
      triangle:       { sig: "triangle(x1, y1, x2, y2, x3, y3)", desc: "Draw a triangle between three points.", cat: "Graphics" },
      quad:           { sig: "quad(x1, y1, x2, y2, x3, y3, x4, y4)", desc: "Draw a quadrilateral between four points.", cat: "Graphics" },

      // Text
      text:           { sig: "text(value, x, y)", desc: "Draw text at (x, y). Uses the current fill color.", cat: "Text" },
      textSize:       { sig: "textSize(size)", desc: "Set the text size scale multiplier.", cat: "Text" },
      textWidth:      { sig: "textWidth(value) -> number", desc: "Measure the pixel width of a string at the current text size.", cat: "Text" },

      // Loop control
      frameRate:      { sig: "frameRate(fps)", desc: "Request a target frame rate (frames per second).", cat: "Loop Control" },
      noLoop:         { sig: "noLoop()", desc: "Stop the draw loop. The sketch freezes on the last frame.", cat: "Loop Control" },
      loop:           { sig: "loop()", desc: "Resume the draw loop after noLoop().", cat: "Loop Control" },
      isLooping:      { sig: "isLooping() -> boolean", desc: "Returns true if the draw loop is running.", cat: "Loop Control" },
      redraw:         { sig: "redraw()", desc: "Request a single draw() call. Useful when looping is off.", cat: "Loop Control" },

      // Input globals
      mouseX:         { sig: "mouseX", desc: "Current mouse/touch X coordinate.", cat: "Input" },
      mouseY:         { sig: "mouseY", desc: "Current mouse/touch Y coordinate.", cat: "Input" },
      pmouseX:        { sig: "pmouseX", desc: "Previous frame mouse X coordinate.", cat: "Input" },
      pmouseY:        { sig: "pmouseY", desc: "Previous frame mouse Y coordinate.", cat: "Input" },
      movedX:         { sig: "movedX", desc: "Mouse X movement delta since last frame.", cat: "Input" },
      movedY:         { sig: "movedY", desc: "Mouse Y movement delta since last frame.", cat: "Input" },
      mouseIsPressed: { sig: "mouseIsPressed", desc: "True while any mouse button or touch is held down.", cat: "Input" },
      key:            { sig: "key", desc: "The value of the last key pressed (string).", cat: "Input" },
      keyCode:        { sig: "keyCode", desc: "The numeric code of the last key pressed.", cat: "Input" },
      keyIsPressed:   { sig: "keyIsPressed", desc: "True while any key is held down.", cat: "Input" },

      // Frame & screen globals
      frameCount:     { sig: "frameCount", desc: "Number of frames drawn since the sketch started.", cat: "Screen" },
      width:          { sig: "width", desc: "Current sketch width in pixels.", cat: "Screen" },
      height:         { sig: "height", desc: "Current sketch height in pixels.", cat: "Screen" },
      deltaTime:      { sig: "deltaTime", desc: "Milliseconds elapsed since the last frame.", cat: "Screen" },
      focused:        { sig: "focused", desc: "Always true in the AC runtime.", cat: "Screen" },

      // Math
      random:         { sig: "random(max?) or random(min, max)", desc: "Generate a random number. No args = 0..1. One arg = 0..max. Two args = min..max.", cat: "Math" },
      map:            { sig: "map(value, inMin, inMax, outMin, outMax)", desc: "Remap a number from one range to another.", cat: "Math" },
      dist:           { sig: "dist(x1, y1, x2, y2) -> number", desc: "Euclidean distance between two points.", cat: "Math" },
      lerp:           { sig: "lerp(start, stop, amount) -> number", desc: "Linear interpolation between two values. amount is 0..1.", cat: "Math" },
      constrain:      { sig: "constrain(value, min, max) -> number", desc: "Clamp a value to the range [min, max].", cat: "Math" },
      radians:        { sig: "radians(degrees) -> number", desc: "Convert degrees to radians.", cat: "Math" },
      degrees:        { sig: "degrees(radians) -> number", desc: "Convert radians to degrees.", cat: "Math" },
      millis:         { sig: "millis() -> number", desc: "Milliseconds elapsed since the sketch started.", cat: "Math" },

      // Constants
      PI:             { sig: "PI = 3.14159...", desc: "The ratio of a circle's circumference to its diameter.", cat: "Constants" },
      HALF_PI:        { sig: "HALF_PI = PI / 2", desc: "Half of PI (90 degrees in radians).", cat: "Constants" },
      QUARTER_PI:     { sig: "QUARTER_PI = PI / 4", desc: "Quarter of PI (45 degrees in radians).", cat: "Constants" },
      TWO_PI:         { sig: "TWO_PI = PI * 2", desc: "Two times PI (360 degrees in radians).", cat: "Constants" },
      TAU:            { sig: "TAU = PI * 2", desc: "Alias for TWO_PI.", cat: "Constants" },
      LEFT:           { sig: "LEFT", desc: "Alignment constant for left-aligned text.", cat: "Constants" },
      RIGHT:          { sig: "RIGHT", desc: "Alignment constant for right-aligned text.", cat: "Constants" },
      CENTER:         { sig: "CENTER", desc: "Alignment constant for centered text.", cat: "Constants" },
      CORNER:         { sig: "CORNER", desc: "Shape mode: (x, y) is the top-left corner.", cat: "Constants" },
      CLOSE:          { sig: "CLOSE", desc: "Used with beginShape/endShape to close the shape.", cat: "Constants" },
      RGB:            { sig: "RGB", desc: "Color mode constant for red/green/blue.", cat: "Constants" },
      HSB:            { sig: "HSB", desc: "Color mode constant for hue/saturation/brightness.", cat: "Constants" },
      HSL:            { sig: "HSL", desc: "Color mode constant for hue/saturation/lightness.", cat: "Constants" },

      // Debug
      print:          { sig: "print(...args)", desc: "Log values to the browser console.", cat: "Debug" },
      println:        { sig: "println(...args)", desc: "Log values to the browser console (alias for print).", cat: "Debug" },
    };

    const state = {
      editor: null,
      fallbackEditor: null,
      iframeReady: false,
      pendingCode: null,
      selectedExampleId: EXAMPLES[0].id,
      monacoReady: false,
    };

    const runtimeStatus = document.getElementById("runtime-status");

    function setRuntimeStatus(message, level = "") {
      runtimeStatus.textContent = message;
      runtimeStatus.classList.remove("ok", "error");
      if (level) runtimeStatus.classList.add(level);
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function getExampleById(id) {
      return EXAMPLES.find((item) => item.id === id) || EXAMPLES[0];
    }

    function getEditorValue() {
      if (state.editor) return state.editor.getValue();
      if (state.fallbackEditor) return state.fallbackEditor.value;
      return "";
    }

    function setEditorValue(value) {
      if (state.editor) {
        state.editor.setValue(value);
      } else if (state.fallbackEditor) {
        state.fallbackEditor.value = value;
      }
    }

    function sendLuaToIframe(code) {
      const frame = document.getElementById("ac-frame");
      if (!frame.contentWindow) {
        setRuntimeStatus("AC iframe unavailable.", "error");
        return;
      }
      frame.contentWindow.postMessage(
        {
          type: "l5-reload",
          code,
          ext: "lua",
          liveName: "l5-live",
        },
        AC_ORIGIN,
      );
      setRuntimeStatus("Lua sent to AC runtime.", "ok");
    }

    function queueOrRun(code) {
      if (!code || !code.trim()) {
        setRuntimeStatus("Cannot run empty Lua source.", "error");
        return;
      }
      if (!state.iframeReady) {
        state.pendingCode = code;
        setRuntimeStatus("Iframe not ready yet. Code queued...", "");
        return;
      }
      sendLuaToIframe(code);
    }

    function initExampleControls() {
      const select = document.getElementById("example-select");
      const source = document.getElementById("example-source");
      const resetBtn = document.getElementById("reset-btn");
      const copyBtn = document.getElementById("copy-btn");
      const runBtn = document.getElementById("run-btn");

      const updateSource = (picked) => {
        source.href = picked.sourceUrl || "https://l5lua.org/examples/";
        source.textContent = picked.sourceUrl ? "L5 Source" : "Source";
      };

      select.innerHTML = EXAMPLES
        .map((item) => `<option value="${item.id}">${escapeHtml(item.title)}</option>`)
        .join("");
      select.value = state.selectedExampleId;
      updateSource(getExampleById(state.selectedExampleId));

      select.addEventListener("change", () => {
        state.selectedExampleId = select.value;
        const picked = getExampleById(state.selectedExampleId);
        updateSource(picked);
        setEditorValue(picked.code);
      });

      resetBtn.addEventListener("click", () => {
        const picked = getExampleById(state.selectedExampleId);
        setEditorValue(picked.code);
        setRuntimeStatus(`Reset to ${picked.title}.`, "");
      });

      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(getEditorValue());
          const old = copyBtn.textContent;
          copyBtn.textContent = "Copied";
          setTimeout(() => {
            copyBtn.textContent = old;
          }, 900);
        } catch (_err) {
          setRuntimeStatus("Clipboard write failed.", "error");
        }
      });

      runBtn.addEventListener("click", () => {
        queueOrRun(getEditorValue());
      });

      window.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          queueOrRun(getEditorValue());
        }
      });
    }

    function initMonacoEditor() {
      const container = document.getElementById("editor");
      const initial = getExampleById(state.selectedExampleId).code;

      if (!window.require) {
        const textarea = document.createElement("textarea");
        textarea.className = "editor-fallback";
        textarea.value = initial;
        container.replaceWith(textarea);
        state.fallbackEditor = textarea;
        setRuntimeStatus("Monaco unavailable. Using fallback editor.", "error");
        return;
      }

      const workerCode = `self.MonacoEnvironment={baseUrl:'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/'};importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/base/worker/workerMain.js');`;
      const workerBlob = new Blob([workerCode], { type: "application/javascript" });
      const workerUrl = URL.createObjectURL(workerBlob);

      window.MonacoEnvironment = {
        getWorkerUrl: () => workerUrl,
      };

      window.require.config({
        paths: {
          vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs",
        },
      });

      window.require(["vs/editor/editor.main"], () => {
        monaco.editor.defineTheme("l5-yellow-dark", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "keyword", foreground: "ffd700" },
            { token: "identifier", foreground: "f6f6f6" },
            { token: "comment", foreground: "999999" },
            { token: "string", foreground: "ffee57" },
          ],
          colors: {
            "editor.background": "#060606",
            "editor.foreground": "#f6f6f6",
            "editorCursor.foreground": "#ffd700",
            "editor.lineHighlightBackground": "#111111",
            "editorLineNumber.foreground": "#666666",
            "editorLineNumber.activeForeground": "#ffd700",
            "editor.selectionBackground": "#ffd70033",
          },
        });

        monaco.editor.defineTheme("l5-yellow-light", {
          base: "vs",
          inherit: true,
          rules: [
            { token: "keyword", foreground: "8b6500" },
            { token: "identifier", foreground: "1a1a1a" },
            { token: "comment", foreground: "6c6c6c" },
            { token: "string", foreground: "945f00" },
          ],
          colors: {
            "editor.background": "#fffdf2",
            "editor.foreground": "#111111",
            "editorCursor.foreground": "#111111",
            "editor.lineHighlightBackground": "#fff6cf",
            "editorLineNumber.foreground": "#8f8f8f",
            "editorLineNumber.activeForeground": "#8b6500",
            "editor.selectionBackground": "#f6d64844",
          },
        });

        const applyEditorTheme = () => {
          const isDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          monaco.editor.setTheme(isDark ? "l5-yellow-dark" : "l5-yellow-light");
        };

        state.editor = monaco.editor.create(container, {
          value: initial,
          language: "lua",
          theme: "l5-yellow-dark",
          minimap: { enabled: false },
          automaticLayout: true,
          tabSize: 2,
          insertSpaces: true,
          fontFamily: "Berkeley Mono Variable, Menlo, monospace",
          fontSize: 13,
          lineHeight: 20,
          scrollBeyondLastLine: false,
          lineNumbers: "on",
          glyphMargin: false,
          folding: false,
          lineDecorationsWidth: 0,
          lineNumbersMinChars: 3,
        });

        applyEditorTheme();
        if (window.matchMedia) {
          window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", applyEditorTheme);
        }

        // Editor-scoped zoom (Cmd/Ctrl + Plus/Minus/0) — prevents page zoom
        let editorFontSize = 13;
        const EDITOR_FONT_MIN = 8;
        const EDITOR_FONT_MAX = 32;
        const EDITOR_FONT_DEFAULT = 13;

        state.editor.onKeyDown((e) => {
          const isMeta = e.metaKey || e.ctrlKey;
          if (!isMeta) return;
          const isPlus = e.keyCode === monaco.KeyCode.Equal || e.keyCode === monaco.KeyCode.NumpadAdd;
          const isMinus = e.keyCode === monaco.KeyCode.Minus || e.keyCode === monaco.KeyCode.NumpadSubtract;
          const isZero = e.keyCode === monaco.KeyCode.Digit0 || e.keyCode === monaco.KeyCode.Numpad0;
          if (isPlus || isMinus || isZero) {
            e.preventDefault();
            e.stopPropagation();
            if (isPlus && editorFontSize < EDITOR_FONT_MAX) editorFontSize += 2;
            else if (isMinus && editorFontSize > EDITOR_FONT_MIN) editorFontSize -= 2;
            else if (isZero) editorFontSize = EDITOR_FONT_DEFAULT;
            state.editor.updateOptions({ fontSize: editorFontSize });
          }
        });

        // Live reload: send code to preview on every edit (debounced)
        let liveTimer = null;
        state.editor.onDidChangeModelContent(() => {
          clearTimeout(liveTimer);
          liveTimer = setTimeout(() => {
            queueOrRun(state.editor.getValue());
          }, 400);
        });

        // Hover provider: show L5 docs on hover
        monaco.languages.registerHoverProvider("lua", {
          provideHover(model, position) {
            const word = model.getWordAtPosition(position);
            if (!word) return;
            const doc = L5_DOCS[word.word];
            if (!doc) return;
            return {
              range: new monaco.Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn),
              contents: [
                { value: `**${doc.cat}**` },
                { value: "```lua\n" + doc.sig + "\n```" },
                { value: doc.desc },
              ],
            };
          },
        });

        // Completion provider: suggest L5 functions while typing
        monaco.languages.registerCompletionItemProvider("lua", {
          provideCompletionItems() {
            return {
              suggestions: Object.entries(L5_DOCS).map(([name, doc]) => ({
                label: name,
                kind: doc.sig.includes("(")
                  ? monaco.languages.CompletionItemKind.Function
                  : monaco.languages.CompletionItemKind.Variable,
                insertText: name,
                detail: doc.sig,
                documentation: doc.desc,
              })),
            };
          },
        });

        // Doc panel: update on cursor position change
        const docPanel = document.getElementById("doc-panel");
        const defaultDocMsg = "Hover over a function to see its docs.";

        function updateDocPanel(word) {
          const doc = word ? L5_DOCS[word] : null;
          if (doc) {
            docPanel.innerHTML =
              `<span class="doc-cat">${escapeHtml(doc.cat)}</span>` +
              `<span class="doc-sig">${escapeHtml(doc.sig)}</span>` +
              `<span class="doc-desc">${escapeHtml(doc.desc)}</span>`;
          } else {
            docPanel.textContent = defaultDocMsg;
          }
        }

        state.editor.onDidChangeCursorPosition((e) => {
          const model = state.editor.getModel();
          const wordInfo = model.getWordAtPosition(e.position);
          updateDocPanel(wordInfo?.word || null);
        });

        state.monacoReady = true;
      });
    }

    function initIframeRunner() {
      const frame = document.getElementById("ac-frame");

      frame.addEventListener("load", () => {
        setRuntimeStatus("AC iframe loaded. Waiting for runtime ready signal...", "");
      });

      window.addEventListener("message", (event) => {
        if (event.origin !== AC_ORIGIN) return;
        const type = event.data?.type;
        if (type === "ready" || type === "kidlisp-ready") {
          state.iframeReady = true;
          setRuntimeStatus("AC runtime ready.", "ok");
          if (state.pendingCode) {
            sendLuaToIframe(state.pendingCode);
            state.pendingCode = null;
          }
        }
      });

      frame.src = FRAME_SRC;
    }

    function initLogoFallback() {
      const img = document.getElementById("brand-logo");
      img.addEventListener("error", () => {
        img.src = "https://aesthetic.computer/l5.aesthetic.computer/l5-logo-blob.png";
      }, { once: true });
    }

    // Live reload via session-server WebSocket (dev mode)
    function initLiveReload() {
      const isDev = location.hostname === "localhost"
        || location.hostname.endsWith(".app.github.dev");
      if (!isDev) return;

      const protocol = location.protocol === "https:" ? "wss:" : "ws:";
      const wsPort = 8889;
      const wsUrl = location.hostname.endsWith(".app.github.dev")
        ? `${protocol}//${location.hostname.replace("-8888", "-" + wsPort)}`
        : `${protocol}//localhost:${wsPort}`;

      let ws;
      function connect() {
        ws = new WebSocket(wsUrl);
        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            if (msg.type === "reload" && msg.content?.piece === "*refresh*") {
              location.reload();
            }
          } catch {}
        };
        ws.onclose = () => setTimeout(connect, 2000);
      }
      connect();
    }

    initLogoFallback();
    initExampleControls();
    initMonacoEditor();
    initIframeRunner();
    initLiveReload();
  </script>
</body>
</html>
