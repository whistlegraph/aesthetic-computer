<!DOCTYPE html>
<!-- KidLisp.com Device Mode - Optimized for FF1 and display devices -->
<!-- URL format: device.kidlisp.com/codeId -->
<!-- Loads KidLisp $code URLs with default density=1 for 4K displays -->
<html>
<head>
  <meta charset="utf-8">
  <title>KidLisp.com Â· Device</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <link rel="icon" type="image/png"
    href="https://pals-aesthetic-computer.sfo3.cdn.digitaloceanspaces.com/painting-2023.7.29.20.39.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    
    #display-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }
    
    /* Boot screen */
    #boot-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #fff;
      z-index: 10;
      transition: opacity 0.5s;
    }
    
    #boot-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Canvas loader */
    #boot-canvas {
      width: 100%;
      height: 100%;
    }
    
    /* Red vignette overlay for timeout warning */
    #vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      background: radial-gradient(ellipse at center, transparent 0%, transparent 30%, rgba(180, 0, 0, 0.8) 100%);
      transition: opacity 1s ease-in;
    }
    
    #vignette.warning {
      opacity: 0.3;
    }
    
    #vignette.danger {
      opacity: 0.6;
    }
    
    #vignette.critical {
      opacity: 1;
      background: radial-gradient(ellipse at center, transparent 0%, transparent 10%, rgba(200, 0, 0, 0.95) 100%);
    }

    /* Error display */
    #error-screen {
      display: none;
      position: absolute;
      inset: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #111;
      z-index: 20;
    }
    
    #error-screen.visible {
      display: flex;
    }
    
    .error-text {
      color: rgb(255, 100, 100);
      font-family: monospace;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <div id="boot-screen">
    <div id="vignette"></div>
    <canvas id="boot-canvas"></canvas>
  </div>
  
  <div id="error-screen">
    <div class="error-text" id="error-text"></div>
  </div>
  
  <iframe id="display-iframe"></iframe>
  
  <script>
    // White bubble Canvas2D loader animation
    const bootCanvas = document.getElementById('boot-canvas');
    const bootCtx = bootCanvas.getContext('2d');
    let bubbleFrame = 0;
    let bubbleAnimating = true;
    
    function resizeBootCanvas() {
      bootCanvas.width = window.innerWidth;
      bootCanvas.height = window.innerHeight;
    }
    resizeBootCanvas();
    window.addEventListener('resize', resizeBootCanvas);
    
    function animateBubble() {
      if (!bubbleAnimating) return;
      
      const W = bootCanvas.width;
      const H = bootCanvas.height;
      const cx = W / 2;
      const cy = H / 2;
      
      // Clear to white
      bootCtx.fillStyle = '#fff';
      bootCtx.fillRect(0, 0, W, H);
      
      // Animated bubble - breathing/pulsing white circle with subtle shadow
      const t = bubbleFrame * 0.03;
      const baseRadius = Math.min(W, H) * 0.08;
      const breathe = Math.sin(t) * 0.15 + 1;
      const radius = baseRadius * breathe;
      
      // Subtle gray shadow
      bootCtx.beginPath();
      bootCtx.arc(cx + 4, cy + 4, radius, 0, Math.PI * 2);
      bootCtx.fillStyle = 'rgba(0, 0, 0, 0.08)';
      bootCtx.fill();
      
      // Main white bubble with light gray stroke
      bootCtx.beginPath();
      bootCtx.arc(cx, cy, radius, 0, Math.PI * 2);
      bootCtx.fillStyle = '#fff';
      bootCtx.fill();
      bootCtx.strokeStyle = 'rgba(0, 0, 0, 0.12)';
      bootCtx.lineWidth = 3;
      bootCtx.stroke();
      
      // Inner highlight
      bootCtx.beginPath();
      bootCtx.arc(cx - radius * 0.3, cy - radius * 0.3, radius * 0.2, 0, Math.PI * 2);
      bootCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      bootCtx.fill();
      
      bubbleFrame++;
      requestAnimationFrame(animateBubble);
    }
    animateBubble();
    
    // Default display parameters for FF1 and 4K displays
    const DEVICE_DEFAULTS = {
      density: 8,     // Higher density = larger pixels (8x8 screen pixels per AC pixel)
      tv: true,       // Non-interactive TV mode
      nogap: true,    // Borderless / no gap
      nolabel: true,  // Hide labels
      noauth: true,   // No auth prompts
      popout: true    // Popout mode
    };
    
    // Parse URL and query params
    const params = new URLSearchParams(window.location.search);
    const pathname = window.location.pathname;
    const hostname = window.location.hostname;
    
    // UI elements
    const iframe = document.getElementById('display-iframe');
    const bootScreen = document.getElementById('boot-screen');
    const errorScreen = document.getElementById('error-screen');
    const errorText = document.getElementById('error-text');
    
    // Boot logging (console only, no DOM log)
    function addLog(msg, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${msg}`);
    }
    
    // Determine display mode and URL
    const dev = hostname === 'localhost' || hostname === 'local.aesthetic.computer';
    const aestheticUrl = dev ? 'https://localhost:8888' : 'https://aesthetic.computer';
    
    const logDevice = (...args) => {
      console.log('ðŸ“º DEVICE:', ...args);
      addLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '));
    };
    
    // Parse codeId from path:
    // device.kidlisp.com/codeId
    // localhost:8888/kidlisp.com/device/codeId
    // localhost:8888/device.kidlisp.com/codeId
    let codeId = null;
    const pathParts = pathname.split('/').filter(p => p);
    
    if (hostname === 'device.kidlisp.com') {
      // Production: device.kidlisp.com/codeId
      codeId = pathParts[0] || null;
    } else if (pathname.startsWith('/device.kidlisp.com/')) {
      // Local dev: localhost:8888/device.kidlisp.com/codeId
      codeId = pathParts[1] || null;
    } else if (pathParts[0] === 'kidlisp.com' && pathParts[1] === 'device') {
      // Local dev: localhost:8888/kidlisp.com/device/codeId
      codeId = pathParts[2] || null;
    }
    
    // Allow param overrides of defaults
    const density = params.get('density') ?? DEVICE_DEFAULTS.density;
    const tv = params.get('tv') ?? DEVICE_DEFAULTS.tv;
    const nogap = params.get('nogap') ?? DEVICE_DEFAULTS.nogap;
    const nolabel = params.get('nolabel') ?? DEVICE_DEFAULTS.nolabel;
    const noauth = params.get('noauth') ?? DEVICE_DEFAULTS.noauth;
    const popout = params.get('popout') ?? DEVICE_DEFAULTS.popout;
    
    // Build query string for display params
    function buildDisplayParams() {
      const p = new URLSearchParams();
      if (density !== null) p.set('density', density);
      if (tv) p.set('tv', 'true');
      if (nogap) p.set('nogap', 'true');
      if (nolabel) p.set('nolabel', 'true');
      if (noauth) p.set('noauth', 'true');
      if (popout) p.set('popout', 'true');
      p.set('t', Date.now()); // Cache bust
      return p.toString();
    }
    
    function showError(msg) {
      errorText.textContent = msg;
      errorScreen.classList.add('visible');
      bootScreen.classList.add('hidden');
      bubbleAnimating = false;
    }
    
    // Initialize display
    function init() {
      logDevice('init', { codeId, density, dev, hostname, pathname });
      
      if (!codeId) {
        showError('Usage: device.kidlisp.com/{codeId}');
        return;
      }
      
      // Set page title
      document.title = `KidLisp.com Â· $${codeId}`;
      
      // Build the $codeId URL with display params
      // ${codeId} loads the stored kidlisp code from MongoDB
      iframe.src = `${aestheticUrl}/$${codeId}?${buildDisplayParams()}`;
      
      logDevice('iframe src', { src: iframe.src });
      
      // Hide boot screen when iframe loads
      iframe.addEventListener('load', () => {
        logDevice('iframe loaded');
        // Don't hide boot screen automatically - wait for AC to signal ready
      });
      
      // Listen for iframe errors
      iframe.addEventListener('error', (e) => {
        addLog(`iframe error: ${e.message || 'unknown'}`, 'error');
      });
      
      // Listen for messages from AC iframe
      window.addEventListener('message', (event) => {
        const data = event.data;
        if (!data) return;
        
        // Log all messages for debugging
        if (typeof data === 'object') {
          if (data.type) {
            addLog(`msg: ${data.type}`);
          }
          // Hide boot screen when AC signals ready
          if (data.type === 'ac-ready' || data.type === 'disk-loaded') {
            logDevice('AC ready, hiding boot screen');
            bubbleAnimating = false;
            setTimeout(() => bootScreen.classList.add('hidden'), 300);
          }
          // Show errors
          if (data.type === 'error' || data.error) {
            addLog(`AC error: ${data.error || data.message || JSON.stringify(data)}`, 'error');
          }
        }
      });
      
      // Vignette element
      const vignette = document.getElementById('vignette');
      
      // Fallback: reload page after 16s if stuck
      // Start vignette warning at 12s (4s before reload)
      setTimeout(() => {
        if (!bootScreen.classList.contains('hidden')) {
          addLog('warning - still loading...', 'warn');
          vignette.classList.add('warning');
        }
      }, 12000);
      
      // Danger at 14s
      setTimeout(() => {
        if (!bootScreen.classList.contains('hidden')) {
          addLog('danger - preparing to reload...', 'warn');
          vignette.classList.remove('warning');
          vignette.classList.add('danger');
        }
      }, 14000);
      
      // Critical at 15s
      setTimeout(() => {
        if (!bootScreen.classList.contains('hidden')) {
          addLog('critical - reloading in 1s...', 'error');
          vignette.classList.remove('danger');
          vignette.classList.add('critical');
        }
      }, 15000);
      
      // Reload at 16s
      setTimeout(() => {
        if (!bootScreen.classList.contains('hidden')) {
          addLog('timeout - reloading page', 'error');
          window.location.reload();
        }
      }, 16000);
    }
    
    // Start
    init();
  </script>
</body>
</html>