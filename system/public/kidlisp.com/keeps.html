<!DOCTYPE html>
<!-- KidLisp.com Keeps - A permanent index of all evaluated KidLisp $codes -->
<!-- URL: keeps.kidlisp.com -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>keeps.kidlisp.com</title>

  <!-- Open Graph / Social Preview -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://keeps.kidlisp.com" />
  <meta property="og:title" content="keeps.kidlisp.com" />
  <meta property="og:description" content="A permanent index of every evaluated KidLisp program, each assigned a unique $code by the Aesthetic Computer database." />
  <meta property="og:image" content="https://oven.aesthetic.computer/kidlisp-og.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="keeps.kidlisp.com" />
  <meta name="twitter:description" content="A permanent index of every evaluated KidLisp program." />
  <meta name="twitter:image" content="https://oven.aesthetic.computer/kidlisp-og.png" />

  <link rel="icon" type="image/gif" href="https://assets.aesthetic.computer/kidlisp-favicon.gif" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Relief:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Sans+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://aesthetic.computer/type/webfonts/berkeley-mono-variable.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <style>
    /* ========================================
       FONTS
       ======================================== */
    @font-face {
      font-family: 'YWFTProcessing-Regular';
      src: url('https://aesthetic.computer/type/webfonts/ywft-processing-regular.woff2') format('woff2'),
           url('https://aesthetic.computer/type/webfonts/ywft-processing-regular.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'YWFTProcessing-Bold';
      src: url('https://aesthetic.computer/type/webfonts/ywft-processing-bold.woff2') format('woff2'),
           url('https://aesthetic.computer/type/webfonts/ywft-processing-bold.woff') format('woff');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    /* ========================================
       CSS VARIABLES (from kidlisp.com)
       ======================================== */
    :root {
      --bg-primary: #f7f7f7;
      --bg-secondary: #e8e8e8;
      --bg-tertiary: white;
      --text-primary: #111;
      --text-secondary: #333;
      --text-tertiary: #666;
      --border-color: #ddd;
      --border-subtle: #e0e0e0;
      --code-bg: #e8e8e8;
      --code-text: #a31515;
      --ac-purple: rgb(205, 92, 155);
      --ac-purple-light: rgb(240, 235, 250);
      --ac-purple-dark: rgb(48, 43, 58);
      --font-mono: 'Noto Sans Mono', 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
      --font-display: 'YWFTProcessing-Regular', monospace;
      --font-fun: 'Comic Relief', 'Comic Sans MS', cursive;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #1e1e1e;
        --bg-secondary: #252526;
        --bg-tertiary: #2d2d30;
        --text-primary: #d4d4d4;
        --text-secondary: #d4d4d4;
        --text-tertiary: #858585;
        --border-color: #3e3e42;
        --border-subtle: #3e3e42;
        --code-bg: #252526;
        --code-text: #ce9178;
      }
    }

    /* ========================================
       RESET & BASE
       ======================================== */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-mono);
      font-size: 14px;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      cursor: url('https://aesthetic.computer/aesthetic.computer/cursors/precise.svg') 12 12, auto;
    }

    a { color: var(--ac-purple); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Colored dot for Aesthetic.Computer links */
    .ac-dot {
      color: #4ECDC4;
      font-weight: bold;
    }

    @media (prefers-color-scheme: dark) {
      .ac-dot { color: #70D6FF; }
    }

    /* ========================================
       HERO HEADER (logo + /keeps inside castle area)
       ======================================== */
    .keeps-hero-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .keeps-logo {
      font-family: var(--font-fun);
      font-weight: bold;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 0;
      text-decoration: none;
    }
    .keeps-logo:hover { text-decoration: none; }

    .keeps-logo .baby-k { color: #FF6B6B; }
    .keeps-logo .baby-i { color: #4ECDC4; }
    .keeps-logo .baby-d { color: #FFE66D; }
    .keeps-logo .baby-l { color: #A8E6CF; }
    .keeps-logo .baby-i2 { color: #FF8B94; }
    .keeps-logo .baby-s { color: #F7DC6F; }
    .keeps-logo .baby-p { color: #BB8FCE; }
    .keeps-logo .com-part { color: #70D6FF; }
    .keeps-logo span { text-shadow: 1px 1px 0px rgba(0,0,0,0.3); }
    .keeps-logo .com-part { text-shadow: none; }

    .keeps-logo .keeps-subdomain {
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--ac-purple);
      text-shadow: 1px 1px 0px rgba(0,0,0,0.2);
      letter-spacing: 0.5px;
    }

    .keeps-count {
      font-size: 12px;
      color: var(--text-tertiary);
      white-space: nowrap;
      margin-left: auto;
    }

    /* ========================================
       CASTLE HERO
       ======================================== */
    .keeps-hero {
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-subtle);
      padding: 24px 24px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .keeps-castle-wrap {
      position: relative;
      width: 100%;
      max-width: 580px;
      height: 280px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .keeps-castle-wrap svg {
      width: 280px;
      height: auto;
      filter: drop-shadow(0 4px 16px rgba(205, 92, 155, 0.22));
    }

    /* Floating $codes rising from castle */
    .keeps-code-float {
      position: absolute;
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      opacity: 0;
      animation: floatUp 6s ease-in-out infinite;
      pointer-events: none;
      text-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }
    .keeps-code-float:nth-child(1) { left: 18%; animation-delay: 0s; color: #FF6B6B; }
    .keeps-code-float:nth-child(2) { left: 35%; animation-delay: 1.2s; color: #4ECDC4; }
    .keeps-code-float:nth-child(3) { left: 52%; animation-delay: 0.6s; color: #FFE66D; }
    .keeps-code-float:nth-child(4) { left: 68%; animation-delay: 2.0s; color: #A8E6CF; }
    .keeps-code-float:nth-child(5) { left: 80%; animation-delay: 3.2s; color: #BB8FCE; }
    .keeps-code-float:nth-child(6) { left: 25%; animation-delay: 4.0s; color: #FF8B94; }
    .keeps-code-float:nth-child(7) { left: 60%; animation-delay: 1.8s; color: #70D6FF; }
    .keeps-code-float:nth-child(8) { left: 42%; animation-delay: 2.8s; color: #F7DC6F; }

    @keyframes floatUp {
      0%   { opacity: 0; transform: translateY(0); }
      10%  { opacity: 1; }
      80%  { opacity: 0.8; }
      100% { opacity: 0; transform: translateY(-200px); }
    }



    /* ========================================
       TABS SYSTEM
       ======================================== */
    .keeps-tabs-container {
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-subtle);
    }

    .keeps-tabs {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .keeps-tab {
      padding: 12px 20px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-tertiary);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      user-select: none;
    }

    .keeps-tab:hover {
      color: var(--text-primary);
      background: rgba(205, 92, 155, 0.05);
    }

    .keeps-tab.active {
      color: var(--ac-purple);
      border-bottom-color: var(--ac-purple);
      font-weight: 500;
    }

    .keeps-tab-content {
      display: none;
      padding: 20px 24px;
      line-height: 1.7;
      font-size: 13px;
      color: var(--text-secondary);
      max-width: 920px;
    }

    .keeps-tab-content.active {
      display: block;
    }

    /* Index tab is full-width with no padding (search bar + grid have their own) */
    #tab-index {
      max-width: none;
      padding: 0;
    }

    .keeps-tab-content p {
      margin: 0 0 10px 0;
    }

    .keeps-tab-content p:last-child { margin-bottom: 0; }

    .keeps-tab-content code {
      background: var(--code-bg);
      color: var(--code-text);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 12px;
    }

    .keeps-tab-content a {
      color: var(--ac-purple);
      text-decoration: none;
    }

    .keeps-tab-content a:hover { text-decoration: underline; }

    .keeps-tab-content h3 {
      font-family: var(--font-display);
      font-size: 15px;
      color: var(--text-primary);
      margin: 20px 0 10px 0;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 6px;
    }

    .keeps-tab-content h3:first-child { margin-top: 0; }

    .keeps-tab-content ul {
      margin: 10px 0;
      padding-left: 24px;
    }

    .keeps-tab-content li {
      margin: 6px 0;
    }

    .keeps-endpoint {
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 12px 16px;
      margin: 12px 0;
    }

    .keeps-endpoint-name {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
      color: var(--ac-purple);
      margin-bottom: 4px;
    }

    .keeps-endpoint-name.v4 {
      color: #FF8B94;
    }

    .keeps-endpoint-name.v4::after {
      content: " ★";
      color: #FFE66D;
      font-size: 12px;
    }

    .keeps-endpoint-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .keeps-endpoint-auth {
      font-size: 11px;
      color: var(--text-tertiary);
      font-style: italic;
    }

    .keeps-endpoint-auth strong {
      color: var(--text-secondary);
      font-style: normal;
    }

    /* ========================================
       LOADING / ERROR STATES
       ======================================== */
    .keeps-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 12px;
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .keeps-loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--ac-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .keeps-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 12px;
      color: var(--text-tertiary);
    }
    .keeps-error .error-icon { font-size: 32px; opacity: 0.5; }
    .keeps-error .error-msg { font-size: 13px; }
    .keeps-error .retry-btn {
      margin-top: 8px;
      padding: 8px 16px;
      background: var(--ac-purple);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .keeps-error .retry-btn:hover { filter: brightness(1.1); }

    /* ========================================
       SEARCH BAR
       ======================================== */
    .keeps-search-bar {
      padding: 12px 24px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keeps-search-input {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.15s;
    }
    .keeps-search-input::placeholder { color: var(--text-tertiary); }
    .keeps-search-input:focus { border-color: var(--ac-purple); }

    .keeps-filter-btn {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .keeps-filter-btn:hover { border-color: var(--ac-purple); }
    .keeps-filter-btn.active {
      background: rgba(205, 92, 155, 0.15);
      border-color: var(--ac-purple);
      color: var(--ac-purple);
    }

    /* ========================================
       GRID
       ======================================== */
    .keeps-grid {
      flex: 1;
      padding: 16px 24px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      align-content: start;
      overflow-y: auto;
    }

    /* ========================================
       CARD
       ======================================== */
    .keeps-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.15s;
      display: flex;
      flex-direction: column;
    }
    .keeps-card:hover {
      border-color: var(--ac-purple);
      box-shadow: 0 2px 12px rgba(205, 92, 155, 0.12);
    }
    .keeps-card.kept {
      border-color: rgba(74, 156, 93, 0.4);
    }
    .keeps-card.kept:hover {
      border-color: #4a9c5d;
      box-shadow: 0 2px 12px rgba(74, 156, 93, 0.15);
    }

    .keeps-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
    }

    .keeps-card-code {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
      color: var(--ac-purple);
      cursor: pointer;
    }
    .keeps-card-code:hover { text-decoration: underline; }

    .keeps-card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .keeps-card-handle {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .keeps-card-hits {
      opacity: 0.7;
    }

    .keeps-card-preview {
      position: relative;
      aspect-ratio: 4 / 3;
      background: #0d0d1a;
      overflow: hidden;
    }

    .keeps-card-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      image-rendering: pixelated;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .keeps-card-preview img.loaded {
      opacity: 0.7;
    }

    .keeps-card:hover .keeps-card-preview img.loaded {
      opacity: 0.9;
    }

    .keeps-card-preview .preview-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.55) 100%);
      pointer-events: none;
    }

    /* Animated noise placeholder (oven style) */
    .keeps-card-preview .preview-noise {
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    .keeps-card-preview .preview-noise canvas {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }
    .keeps-card-preview .preview-noise .oven-label {
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      text-align: center;
      font-family: var(--font-mono);
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      letter-spacing: 1px;
      pointer-events: none;
    }
    .keeps-card-preview .preview-noise .oven-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--ac-purple), #70D6FF);
      animation: oven-pulse 1.5s ease-in-out infinite;
    }
    @keyframes oven-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    .keeps-card-body {
      padding: 10px 12px;
      flex: 1;
      min-height: 0;
    }

    /* Syntax-highlighted source with colored line numbers */
    .keeps-card-source {
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.5;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 100px;
      overflow-y: auto;
      position: relative;
      display: flex;
    }

    /* KidLisp syntax highlighting tokens */
    .kl-comment { color: #6b7280; font-style: italic; }
    .kl-string { color: #eab308; }
    .kl-number { color: #f472b6; }
    .kl-fn { color: #22d3ee; }
    .kl-special { color: #c084fc; }
    .kl-op { color: #84cc16; }
    .kl-var { color: #fb923c; }
    .kl-code-ref { color: #4ade80; }
    .kl-paren { color: #9ca3af; }

    @media (prefers-color-scheme: dark) {
      .kl-comment { color: #6b7280; }
      .kl-string { color: #e5c07b; }
      .kl-number { color: #d19a66; }
      .kl-fn { color: #61afef; }
      .kl-special { color: #c084fc; }
      .kl-op { color: #98c379; }
      .kl-var { color: #e06c75; }
      .kl-code-ref { color: #98c379; }
      .kl-paren { color: #858585; }
    }

    .keeps-card-source .line-nums {
      flex-shrink: 0;
      width: 2.2em;
      text-align: right;
      padding-right: 6px;
      user-select: none;
      border-right: 1px solid var(--border-subtle);
      margin-right: 6px;
    }

    .keeps-card-source .line-nums span {
      display: block;
      opacity: 0.7;
    }
    .keeps-card-source .line-nums span:nth-child(6n+1) { color: #FF6B6B; }
    .keeps-card-source .line-nums span:nth-child(6n+2) { color: #4ECDC4; }
    .keeps-card-source .line-nums span:nth-child(6n+3) { color: #FFE66D; }
    .keeps-card-source .line-nums span:nth-child(6n+4) { color: #A8E6CF; }
    .keeps-card-source .line-nums span:nth-child(6n+5) { color: #70D6FF; }
    .keeps-card-source .line-nums span:nth-child(6n+6) { color: #BB8FCE; }

    .keeps-card-source .source-text {
      flex: 1;
      min-width: 0;
    }


    .keeps-card-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .keeps-card-btn {
      padding: 4px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .keeps-card-btn:hover {
      border-color: var(--ac-purple);
      color: var(--ac-purple);
      text-decoration: none;
    }

    .keeps-card-btn.kept-badge {
      background: rgba(74, 156, 93, 0.15);
      border-color: rgba(74, 156, 93, 0.3);
      color: #4a9c5d;
      cursor: default;
    }

    .keeps-card-btn.html-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.5);
      color: #3b82f6;
    }

    .keeps-card-btn.tezos-btn:hover {
      background: rgba(74, 156, 93, 0.1);
      border-color: rgba(74, 156, 93, 0.5);
      color: #4a9c5d;
    }

    /* ========================================
       PREVIEW MODAL
       ======================================== */
    .keeps-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    .keeps-modal-overlay.open {
      display: flex;
      animation: modalFadeIn 0.2s ease-out forwards;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalScaleIn {
      from { transform: scale(0.92); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .keeps-modal {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalScaleIn 0.25s ease-out;
    }

    .keeps-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .keeps-modal-title {
      font-family: var(--font-mono);
      font-size: 16px;
      font-weight: 700;
      color: var(--ac-purple);
    }

    .keeps-modal-close {
      width: 32px;
      height: 32px;
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 18px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .keeps-modal-close:hover {
      background: var(--bg-tertiary);
      border-color: var(--ac-purple);
      color: var(--ac-purple);
    }

    .keeps-modal-body {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .keeps-modal-preview {
      flex: 1;
      min-width: 0;
      background: black;
      position: relative;
    }

    .keeps-modal-preview iframe {
      width: 100%;
      height: 100%;
      border: none;
      min-height: 360px;
    }

    .keeps-modal-sidebar {
      width: 300px;
      flex-shrink: 0;
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .keeps-modal-source {
      padding: 16px;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      flex: 1;
      overflow-y: auto;
      background: var(--bg-tertiary);
    }

    .keeps-modal-source .line-nums span {
      display: block;
      opacity: 0.7;
    }
    .keeps-modal-source .line-nums span:nth-child(6n+1) { color: #FF6B6B; }
    .keeps-modal-source .line-nums span:nth-child(6n+2) { color: #4ECDC4; }
    .keeps-modal-source .line-nums span:nth-child(6n+3) { color: #FFE66D; }
    .keeps-modal-source .line-nums span:nth-child(6n+4) { color: #A8E6CF; }
    .keeps-modal-source .line-nums span:nth-child(6n+5) { color: #70D6FF; }
    .keeps-modal-source .line-nums span:nth-child(6n+6) { color: #BB8FCE; }

    .keeps-modal-actions {
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 1px solid var(--border-subtle);
      background: var(--bg-secondary);
    }

    .keeps-modal-action-btn {
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .keeps-modal-action-btn.edit-btn {
      background: var(--ac-purple);
      color: white;
      border-color: var(--ac-purple);
    }
    .keeps-modal-action-btn.edit-btn:hover { filter: brightness(1.1); text-decoration: none; }

    .keeps-modal-action-btn.html-btn {
      background: var(--bg-tertiary);
      color: #3b82f6;
      border-color: rgba(59, 130, 246, 0.3);
    }
    .keeps-modal-action-btn.html-btn:hover { background: rgba(59, 130, 246, 0.1); text-decoration: none; }

    .keeps-modal-action-btn.tezos-btn {
      background: var(--bg-tertiary);
      color: #4a9c5d;
      border-color: rgba(74, 156, 93, 0.3);
    }
    .keeps-modal-action-btn.tezos-btn:hover { background: rgba(74, 156, 93, 0.1); text-decoration: none; }

    .keeps-modal-info {
      padding: 10px 16px;
      font-size: 11px;
      color: var(--text-tertiary);
      border-top: 1px solid var(--border-subtle);
    }
    .keeps-modal-info span { display: block; margin-bottom: 2px; }

    /* ========================================
       FOOTER
       ======================================== */
    .keeps-footer {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 14px 24px;
      text-align: center;
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }
    .keeps-footer a { color: var(--ac-purple); }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 768px) {
      .keeps-hero { padding: 16px 16px 0; }
      .keeps-castle-wrap { height: 220px; }
      .keeps-castle-wrap svg { width: 200px; }
      .keeps-search-bar { padding: 10px 16px; flex-wrap: wrap; }
      .keeps-grid { padding: 12px 16px; grid-template-columns: 1fr; }
      .keeps-modal-body { flex-direction: column; }
      .keeps-modal-sidebar { width: 100%; border-left: none; border-top: 1px solid var(--border-color); max-height: 240px; }
      .keeps-modal-preview iframe { min-height: 240px; }
    }

    @media (max-width: 480px) {
      .keeps-grid { grid-template-columns: 1fr; gap: 10px; }
      .keeps-card-actions { flex-wrap: wrap; }
    }

    /* Embedded in parent editor iframe — hide branding */
    .embedded .keeps-hero { display: none; }
  </style>
  <script>if (window.self !== window.top) document.documentElement.classList.add('embedded');</script>
</head>

<body>
  <!-- CASTLE HERO -->
  <section class="keeps-hero">
    <div class="keeps-hero-header">
      <a href="/" class="keeps-logo" title="Back to KidLisp.com editor">
        <span class="keeps-subdomain">keeps</span><span class="com-part">.</span><span class="baby-k">K</span><span class="baby-i">i</span><span class="baby-d">d</span><span class="baby-l">L</span><span class="baby-i2">i</span><span class="baby-s">s</span><span class="baby-p">p</span><span class="com-part">.com</span>
      </a>
      <span class="keeps-count" id="keeps-count"></span>
    </div>
    <div class="keeps-castle-wrap">
      <!-- Floating $codes -->
      <span class="keeps-code-float">$39j</span>
      <span class="keeps-code-float">$a1b</span>
      <span class="keeps-code-float">$zyx</span>
      <span class="keeps-code-float">$k7m</span>
      <span class="keeps-code-float">$p2q</span>
      <span class="keeps-code-float">$n4f</span>
      <span class="keeps-code-float">$h8w</span>
      <span class="keeps-code-float">$c3v</span>
      <!-- Castle SVG — detailed keep fortress -->
      <svg viewBox="0 0 300 240" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Stone texture pattern -->
          <pattern id="stones" x="0" y="0" width="20" height="12" patternUnits="userSpaceOnUse">
            <rect width="20" height="12" fill="none"/>
            <line x1="0" y1="6" x2="20" y2="6" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.15"/>
            <line x1="10" y1="0" x2="10" y2="6" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.15"/>
            <line x1="0" y1="0" x2="0" y2="6" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.1"/>
            <line x1="5" y1="6" x2="5" y2="12" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.15"/>
            <line x1="15" y1="6" x2="15" y2="12" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.15"/>
          </pattern>
          <!-- Glow for sparkles -->
          <filter id="glow">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>

        <!-- Ground / hill base -->
        <ellipse cx="150" cy="238" rx="140" ry="16" fill="var(--text-tertiary)" opacity="0.12"/>

        <!-- Foundation stone -->
        <rect x="45" y="170" width="210" height="68" rx="3" fill="var(--text-tertiary)" opacity="0.15"/>

        <!-- === MAIN CURTAIN WALL === -->
        <rect x="55" y="108" width="190" height="130" rx="2" fill="var(--ac-purple)" opacity="0.18"/>
        <rect x="57" y="110" width="186" height="126" rx="2" fill="var(--bg-tertiary)" stroke="var(--ac-purple)" stroke-width="1.2" opacity="0.95"/>
        <!-- Stone texture overlay on wall -->
        <rect x="57" y="110" width="186" height="126" rx="2" fill="url(#stones)"/>

        <!-- Wall horizontal mortar lines -->
        <line x1="60" y1="130" x2="240" y2="130" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.12"/>
        <line x1="60" y1="150" x2="240" y2="150" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.12"/>
        <line x1="60" y1="170" x2="240" y2="170" stroke="var(--ac-purple)" stroke-width="0.3" opacity="0.12"/>

        <!-- === GATEHOUSE === -->
        <!-- Arch recess -->
        <rect x="118" y="165" width="64" height="73" rx="2" fill="var(--ac-purple)" opacity="0.1"/>
        <!-- Arch -->
        <path d="M120 238 V185 Q120 160 150 160 Q180 160 180 185 V238" fill="var(--ac-purple)" opacity="0.15"/>
        <path d="M122 238 V186 Q122 163 150 163 Q178 163 178 186 V238" fill="none" stroke="var(--ac-purple)" stroke-width="1.5"/>
        <!-- Portcullis grid -->
        <line x1="134" y1="163" x2="134" y2="238" stroke="var(--ac-purple)" stroke-width="0.6" opacity="0.25"/>
        <line x1="142" y1="163" x2="142" y2="238" stroke="var(--ac-purple)" stroke-width="0.6" opacity="0.25"/>
        <line x1="150" y1="160" x2="150" y2="238" stroke="var(--ac-purple)" stroke-width="0.6" opacity="0.25"/>
        <line x1="158" y1="163" x2="158" y2="238" stroke="var(--ac-purple)" stroke-width="0.6" opacity="0.25"/>
        <line x1="166" y1="163" x2="166" y2="238" stroke="var(--ac-purple)" stroke-width="0.6" opacity="0.25"/>
        <line x1="122" y1="190" x2="178" y2="190" stroke="var(--ac-purple)" stroke-width="0.5" opacity="0.2"/>
        <line x1="122" y1="200" x2="178" y2="200" stroke="var(--ac-purple)" stroke-width="0.5" opacity="0.2"/>
        <line x1="122" y1="210" x2="178" y2="210" stroke="var(--ac-purple)" stroke-width="0.5" opacity="0.2"/>
        <line x1="122" y1="220" x2="178" y2="220" stroke="var(--ac-purple)" stroke-width="0.5" opacity="0.2"/>
        <!-- Keystone -->
        <path d="M144 162 L150 156 L156 162" fill="var(--ac-purple)" opacity="0.3"/>

        <!-- === LEFT MAIN TOWER === -->
        <rect x="30" y="68" width="44" height="170" rx="2" fill="var(--ac-purple)" opacity="0.15"/>
        <rect x="32" y="70" width="40" height="166" rx="2" fill="var(--bg-tertiary)" stroke="var(--ac-purple)" stroke-width="1.2"/>
        <rect x="32" y="70" width="40" height="166" rx="2" fill="url(#stones)"/>
        <!-- Left tower conical roof -->
        <polygon points="52,30 28,65 76,65" fill="var(--ac-purple)" opacity="0.3"/>
        <polygon points="52,30 28,65 76,65" fill="none" stroke="var(--ac-purple)" stroke-width="1"/>
        <!-- Roof shingle lines -->
        <line x1="38" y1="50" x2="66" y2="50" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.3"/>
        <line x1="42" y1="42" x2="62" y2="42" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.3"/>
        <!-- Left tower battlements -->
        <rect x="28" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="40" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="56" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="68" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <!-- Left tower windows (arched) -->
        <rect x="44" y="85" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <rect x="44" y="115" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <rect x="44" y="145" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <!-- Window glow -->
        <rect x="45" y="86" width="8" height="12" rx="4" fill="#FFE66D" opacity="0.08"/>
        <rect x="45" y="116" width="8" height="12" rx="4" fill="#70D6FF" opacity="0.08"/>

        <!-- === RIGHT MAIN TOWER === -->
        <rect x="226" y="68" width="44" height="170" rx="2" fill="var(--ac-purple)" opacity="0.15"/>
        <rect x="228" y="70" width="40" height="166" rx="2" fill="var(--bg-tertiary)" stroke="var(--ac-purple)" stroke-width="1.2"/>
        <rect x="228" y="70" width="40" height="166" rx="2" fill="url(#stones)"/>
        <!-- Right tower conical roof -->
        <polygon points="248,30 224,65 272,65" fill="var(--ac-purple)" opacity="0.3"/>
        <polygon points="248,30 224,65 272,65" fill="none" stroke="var(--ac-purple)" stroke-width="1"/>
        <line x1="234" y1="50" x2="262" y2="50" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.3"/>
        <line x1="238" y1="42" x2="258" y2="42" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.3"/>
        <!-- Right tower battlements -->
        <rect x="224" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="236" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="252" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <rect x="264" y="62" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.45"/>
        <!-- Right tower windows -->
        <rect x="244" y="85" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <rect x="244" y="115" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <rect x="244" y="145" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.22"/>
        <rect x="245" y="86" width="8" height="12" rx="4" fill="#FFE66D" opacity="0.08"/>
        <rect x="245" y="116" width="8" height="12" rx="4" fill="#70D6FF" opacity="0.08"/>

        <!-- === CENTER TURRET (taller) === -->
        <rect x="130" y="80" width="40" height="78" rx="2" fill="var(--ac-purple)" opacity="0.12"/>
        <rect x="132" y="82" width="36" height="74" rx="2" fill="var(--bg-tertiary)" stroke="var(--ac-purple)" stroke-width="1"/>
        <rect x="132" y="82" width="36" height="74" rx="2" fill="url(#stones)"/>
        <!-- Center turret conical roof -->
        <polygon points="150,42 126,78 174,78" fill="var(--ac-purple)" opacity="0.25"/>
        <polygon points="150,42 126,78 174,78" fill="none" stroke="var(--ac-purple)" stroke-width="1"/>
        <line x1="136" y1="63" x2="164" y2="63" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.3"/>
        <!-- Center battlements -->
        <rect x="128" y="75" width="7" height="9" rx="1" fill="var(--ac-purple)" opacity="0.4"/>
        <rect x="139" y="75" width="7" height="9" rx="1" fill="var(--ac-purple)" opacity="0.4"/>
        <rect x="154" y="75" width="7" height="9" rx="1" fill="var(--ac-purple)" opacity="0.4"/>
        <rect x="165" y="75" width="7" height="9" rx="1" fill="var(--ac-purple)" opacity="0.4"/>
        <!-- Center window (rosette) -->
        <circle cx="150" cy="100" r="8" fill="var(--ac-purple)" opacity="0.18"/>
        <circle cx="150" cy="100" r="6" fill="none" stroke="var(--ac-purple)" stroke-width="0.5" opacity="0.3"/>
        <line x1="150" y1="94" x2="150" y2="106" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.2"/>
        <line x1="144" y1="100" x2="156" y2="100" stroke="var(--ac-purple)" stroke-width="0.4" opacity="0.2"/>

        <!-- === WALL BATTLEMENTS (between towers) === -->
        <!-- Left section -->
        <rect x="72" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="84" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="96" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="108" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <!-- Right section -->
        <rect x="184" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="196" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="208" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>
        <rect x="220" y="102" width="8" height="10" rx="1" fill="var(--ac-purple)" opacity="0.35"/>

        <!-- === WALL WINDOWS (arrow slits + arched) === -->
        <!-- Left wall -->
        <rect x="78" y="130" width="4" height="14" rx="2" fill="var(--ac-purple)" opacity="0.2"/>
        <rect x="98" y="125" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.18"/>
        <rect x="78" y="160" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.18"/>
        <!-- Right wall -->
        <rect x="218" y="130" width="4" height="14" rx="2" fill="var(--ac-purple)" opacity="0.2"/>
        <rect x="192" y="125" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.18"/>
        <rect x="212" y="160" width="10" height="14" rx="5" fill="var(--ac-purple)" opacity="0.18"/>

        <!-- === FLAGS === -->
        <!-- Left tower flag -->
        <line x1="52" y1="30" x2="52" y2="10" stroke="var(--ac-purple)" stroke-width="1"/>
        <path d="M52 10 L66 15 L52 20" fill="#FF6B6B" opacity="0.75">
          <animateTransform attributeName="transform" type="rotate" values="-2,52,15;2,52,15;-2,52,15" dur="3s" repeatCount="indefinite"/>
        </path>
        <!-- Center flag -->
        <line x1="150" y1="42" x2="150" y2="16" stroke="var(--ac-purple)" stroke-width="1.2"/>
        <path d="M150 16 L168 22 L150 28" fill="#4ECDC4" opacity="0.8">
          <animateTransform attributeName="transform" type="rotate" values="-3,150,22;3,150,22;-3,150,22" dur="2.5s" repeatCount="indefinite"/>
        </path>
        <!-- Right tower flag -->
        <line x1="248" y1="30" x2="248" y2="10" stroke="var(--ac-purple)" stroke-width="1"/>
        <path d="M248 10 L262 15 L248 20" fill="#BB8FCE" opacity="0.75">
          <animateTransform attributeName="transform" type="rotate" values="2,248,15;-2,248,15;2,248,15" dur="3.5s" repeatCount="indefinite"/>
        </path>

        <!-- === TREASURE SPARKLES (inside gate) === -->
        <circle cx="150" cy="175" r="2.5" fill="#FFE66D" opacity="0.8" filter="url(#glow)">
          <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="140" cy="195" r="2" fill="#A8E6CF" opacity="0.6" filter="url(#glow)">
          <animate attributeName="opacity" values="0.2;0.9;0.2" dur="2.5s" repeatCount="indefinite"/>
        </circle>
        <circle cx="160" cy="190" r="2" fill="#70D6FF" opacity="0.6" filter="url(#glow)">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="1.8s" repeatCount="indefinite"/>
        </circle>
        <circle cx="145" cy="210" r="1.5" fill="#FF8B94" opacity="0.5" filter="url(#glow)">
          <animate attributeName="opacity" values="0.3;0.8;0.3" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="155" cy="205" r="1.5" fill="#BB8FCE" opacity="0.5" filter="url(#glow)">
          <animate attributeName="opacity" values="0.2;0.7;0.2" dur="2.2s" repeatCount="indefinite"/>
        </circle>

        <!-- === TOWER WINDOW GLIMMERS === -->
        <circle cx="49" cy="92" r="1" fill="#FFE66D" opacity="0">
          <animate attributeName="opacity" values="0;0.6;0" dur="4s" repeatCount="indefinite"/>
        </circle>
        <circle cx="249" cy="122" r="1" fill="#70D6FF" opacity="0">
          <animate attributeName="opacity" values="0;0.5;0" dur="5s" begin="1s" repeatCount="indefinite"/>
        </circle>
        <circle cx="150" cy="100" r="1.5" fill="#F7DC6F" opacity="0">
          <animate attributeName="opacity" values="0;0.4;0" dur="3.5s" begin="0.5s" repeatCount="indefinite"/>
        </circle>
      </svg>
    </div>
  </section>

  <!-- TABS SYSTEM -->
  <div class="keeps-tabs-container">
    <div class="keeps-tabs">
      <button class="keeps-tab active" data-tab="index">Index</button>
      <button class="keeps-tab" data-tab="v4docs">V4 Docs</button>
      <button class="keeps-tab" data-tab="about">About</button>
    </div>

    <!-- TAB: Index (default view - search + grid) -->
    <div class="keeps-tab-content active" id="tab-index">
      <div class="keeps-search-bar">
        <input type="text" class="keeps-search-input" id="search-input"
               placeholder="Search $codes, source code, or @handles..." autocomplete="off" spellcheck="false" />
        <button class="keeps-filter-btn" id="filter-kept" title="Show only pieces kept on Tezos">Kept on Tezos</button>
      </div>
      <div class="keeps-grid" id="keeps-grid">
        <div class="keeps-loading" id="keeps-loading">
          <div class="spinner"></div>
          <span>Loading all $codes...</span>
        </div>
      </div>
    </div>

    <!-- TAB: V4 Docs -->
    <div class="keeps-tab-content" id="tab-v4docs">
      <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
        <h2 style="margin: 0 0 16px; color: var(--text-primary); font-size: 24px; font-weight: 600;">
          Keeps FA2 v4 Contract Documentation
        </h2>

        <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
          <div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500;">Contract Address</div>
          <div style="font-family: 'Courier New', monospace; color: var(--ac-purple); font-size: 14px; word-break: break-all;">
            KT1ER1GyoeRNhkv6E57yKbBbEKi5ynKbaH3W
          </div>
          <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
            <a href="https://tzkt.io/KT1ER1GyoeRNhkv6E57yKbBbEKi5ynKbaH3W" target="_blank"
               style="padding: 6px 12px; background: var(--ac-purple); color: white; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
              View on TzKT
            </a>
            <a href="https://objkt.com/collection/keeps" target="_blank"
               style="padding: 6px 12px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
              View on objkt
            </a>
            <a href="https://github.com/whistlegraph/aesthetic-computer/blob/main/tezos/keeps_fa2_v4.py" target="_blank"
               style="padding: 6px 12px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
              Source Code
            </a>
          </div>
        </div>

        <p style="margin-bottom: 24px; color: var(--text-secondary); line-height: 1.6;">
          The Keeps FA2 v4 contract is a full-featured NFT system with 23 total endpoints.
          It implements the TZIP-012 (FA2) standard with custom extensions for content deduplication,
          editable metadata, royalties, and emergency controls.
        </p>

        <div style="margin-bottom: 32px;">
          <h3 style="margin: 0 0 16px; color: var(--text-primary); font-size: 18px; font-weight: 600; border-bottom: 2px solid var(--ac-purple); padding-bottom: 8px;">
            Custom Endpoints (12)
          </h3>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name v4">★ pause</div>
            <div class="keeps-endpoint-desc">Emergency pause contract (blocks minting/editing, allows transfers)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px; font-style: italic;">New in v4 • Enables emergency stop without breaking FA2 composability</div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name v4">★ unpause</div>
            <div class="keeps-endpoint-desc">Resume normal contract operations after pause</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px; font-style: italic;">New in v4 • Allows safe contract recovery</div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name v4">★ set_default_royalty</div>
            <div class="keeps-endpoint-desc">Set default royalty percentage for all tokens (0-25%)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px; font-style: italic;">New in v4 • Currently set to 10% (1000 basis points)</div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name v4">★ admin_transfer</div>
            <div class="keeps-endpoint-desc">Emergency transfer for recovery (validates current owner)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px; font-style: italic;">New in v4 • Safety feature for lost access recovery</div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">keep</div>
            <div class="keeps-endpoint-desc">Mint a new token with metadata (requires fee payment or admin)</div>
            <div class="keeps-endpoint-auth">Auth: admin (free) or user (with fee)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> to (address), metadata (bytes), content_hash (bytes)
            </div>
            <div class="keeps-endpoint-desc" style="margin-top: 4px; font-style: italic;">
              Enforces unique content_hash to prevent duplicates
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">edit_metadata</div>
            <div class="keeps-endpoint-desc">Update token metadata (if not locked)</div>
            <div class="keeps-endpoint-auth">Auth: admin, current owner, or original creator</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> token_id (nat), new_metadata (bytes)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">lock_metadata</div>
            <div class="keeps-endpoint-desc">Permanently lock token metadata (irreversible)</div>
            <div class="keeps-endpoint-auth">Auth: admin or current owner</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> token_id (nat)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">set_contract_metadata</div>
            <div class="keeps-endpoint-desc">Update contract-level metadata (name, description, etc.)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> list of (key, value) pairs
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">lock_contract_metadata</div>
            <div class="keeps-endpoint-desc">Permanently lock contract metadata (irreversible)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px; font-style: italic;">
              Currently unlocked to allow updates
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">set_keep_fee</div>
            <div class="keeps-endpoint-desc">Set minting fee in mutez (tez × 1,000,000)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> fee_mutez (nat)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">withdraw_fees</div>
            <div class="keeps-endpoint-desc">Withdraw collected fees to specified address</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> destination (address)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">burn_keep</div>
            <div class="keeps-endpoint-desc">Permanently delete a token (admin emergency use only)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> token_id (nat)
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3 style="margin: 0 0 16px; color: var(--text-primary); font-size: 18px; font-weight: 600; border-bottom: 2px solid var(--ac-purple); padding-bottom: 8px;">
            FA2 Standard Endpoints (6)
          </h3>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">transfer</div>
            <div class="keeps-endpoint-desc">Transfer tokens between addresses (FA2 standard)</div>
            <div class="keeps-endpoint-auth">Auth: owner or approved operator</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> list of (from, to, token_id, amount) transfers
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">update_operators</div>
            <div class="keeps-endpoint-desc">Add or remove approved operators for your tokens</div>
            <div class="keeps-endpoint-auth">Auth: token owner</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> list of add_operator or remove_operator actions
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">balance_of</div>
            <div class="keeps-endpoint-desc">Query token balances (callback pattern)</div>
            <div class="keeps-endpoint-auth">Auth: public</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> requests (list), callback (contract)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">mint</div>
            <div class="keeps-endpoint-desc">Basic FA2 mint (use 'keep' instead for content deduplication)</div>
            <div class="keeps-endpoint-auth">Auth: admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> to (address), metadata (bytes)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">burn</div>
            <div class="keeps-endpoint-desc">Burn your own token (owner-initiated)</div>
            <div class="keeps-endpoint-auth">Auth: token owner</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> token_id (nat)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">set_administrator</div>
            <div class="keeps-endpoint-desc">Transfer admin role to new address</div>
            <div class="keeps-endpoint-auth">Auth: current admin only</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> new_admin (address)
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3 style="margin: 0 0 16px; color: var(--text-primary); font-size: 18px; font-weight: 600; border-bottom: 2px solid var(--ac-purple); padding-bottom: 8px;">
            On-Chain Views (5)
          </h3>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">get_balance</div>
            <div class="keeps-endpoint-desc">Get balance for owner/token_id pair</div>
            <div class="keeps-endpoint-auth">Auth: public (read-only)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Returns:</strong> nat (0 or 1 for NFTs)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">total_supply</div>
            <div class="keeps-endpoint-desc">Get total supply for a token_id</div>
            <div class="keeps-endpoint-auth">Auth: public (read-only)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Returns:</strong> nat (1 if exists, 0 if burned)
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">is_operator</div>
            <div class="keeps-endpoint-desc">Check if address is approved operator</div>
            <div class="keeps-endpoint-auth">Auth: public (read-only)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Params:</strong> owner (address), operator (address), token_id (nat)
              <br><strong>Returns:</strong> bool
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">all_tokens</div>
            <div class="keeps-endpoint-desc">Get list of all token IDs (paginated)</div>
            <div class="keeps-endpoint-auth">Auth: public (read-only)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Returns:</strong> list of nat
            </div>
          </div>

          <div class="keeps-endpoint">
            <div class="keeps-endpoint-name">get_balance_of</div>
            <div class="keeps-endpoint-desc">Batch balance query (view version of balance_of)</div>
            <div class="keeps-endpoint-auth">Auth: public (read-only)</div>
            <div class="keeps-endpoint-desc" style="margin-top: 8px;">
              <strong>Returns:</strong> list of (owner, token_id, balance) tuples
            </div>
          </div>
        </div>

        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--ac-purple);">
          <h4 style="margin: 0 0 8px; color: var(--text-primary); font-size: 16px; font-weight: 600;">Version History</h4>
          <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
            <li><strong>v4.0</strong> - Added royalty support, emergency pause/unpause, admin_transfer</li>
            <li><strong>v3.0</strong> - Added editable metadata, creator tracking, fee system</li>
            <li><strong>v2.0</strong> - Content hash deduplication</li>
            <li><strong>v1.0</strong> - Basic FA2 implementation</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- TAB: About -->
    <div class="keeps-tab-content" id="tab-about">
      <p>
        Every KidLisp program evaluated on <a href="https://aesthetic.computer" target="_blank">Aesthetic<span class="ac-dot">.</span>Computer</a>
        is assigned a permanent <code>$code</code> &mdash; a short, unique identifier stored forever in the
        <a href="https://aesthetic.computer" target="_blank">Aesthetic<span class="ac-dot">.</span>Computer</a> database.
        This page is a living index of every <code>$code</code> ever created &mdash; a castle full of keeps.
      </p>
      <h3>What is a $code?</h3>
      <p>
        When you write and run KidLisp on
        <a href="https://kidlisp.com">kidlisp.com</a> or <a href="https://aesthetic.computer" target="_blank">Aesthetic<span class="ac-dot">.</span>Computer</a>,
        the source is hashed and stored. If it&rsquo;s new, a unique short code like <code>$39j</code> is generated.
        Identical source always resolves to the same <code>$code</code>.
      </p>
      <h3>Keeping as HTML</h3>
      <p>
        Any <code>$code</code> can be bundled into a self-contained HTML file
        via the <code>/api/bundle-html</code> endpoint. This creates a standalone artifact that runs independently,
        perfect for archiving or embedding.
      </p>
      <h3>Keeping on Tezos</h3>
      <p>
        KidLisp programs can be minted as on-chain NFTs on the
        Tezos blockchain, making them permanently decentralized. Kept pieces are marked with a green badge below.
      </p>
      <h3>Links</h3>
      <p>
        Visit any code at <code>kidlisp.com/$code</code> to edit,
        or <code>aesthetic.computer/$code</code> to run fullscreen.
      </p>
    </div>

  </div>

  <!-- PREVIEW MODAL -->
  <div class="keeps-modal-overlay" id="modal-overlay">
    <div class="keeps-modal">
      <div class="keeps-modal-header">
        <span class="keeps-modal-title" id="modal-title">$code</span>
        <button class="keeps-modal-close" id="modal-close" title="Close">&times;</button>
      </div>
      <div class="keeps-modal-body">
        <div class="keeps-modal-preview">
          <iframe id="modal-iframe" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
        </div>
        <div class="keeps-modal-sidebar">
          <div class="keeps-modal-source" id="modal-source"></div>
          <div class="keeps-modal-actions" id="modal-actions"></div>
          <div class="keeps-modal-info" id="modal-info"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="keeps-footer">
    <a href="https://kidlisp.com">kidlisp.com</a> &middot;
    <a href="https://aesthetic.computer" target="_blank">Aesthetic<span class="ac-dot">.</span>Computer</a> &middot;
    Permanent code storage &mdash; a castle full of keeps.
  </footer>

  <script>
    // =========================================
    // KidLisp.com Keeps - Index Page
    // =========================================

    const isDev = window.location.hostname === 'localhost' || window.location.hostname === 'local.aesthetic.computer';
    const isKidlispDomain = window.location.hostname.includes('kidlisp.com');
    // Use relative API paths on kidlisp.com (proxied via Netlify), absolute on dev
    const API_BASE = isDev ? 'http://localhost:8888' : (isKidlispDomain ? '' : 'https://aesthetic.computer');
    const AC_BASE = isDev ? 'http://localhost:8888' : 'https://aesthetic.computer';
    const KL_BASE = isDev ? 'http://localhost:8888/kidlisp.com' : 'https://kidlisp.com';

    let allCodes = [];
    let filteredCodes = [];
    let showOnlyKept = false;
    let searchQuery = '';

    // Pagination: render in batches to avoid freezing on large datasets
    const PAGE_SIZE = 50;
    let renderedCount = 0;
    let isLoadingMore = false;

    // DOM
    const grid = document.getElementById('keeps-grid');
    const loading = document.getElementById('keeps-loading');
    const countEl = document.getElementById('keeps-count');
    const searchInput = document.getElementById('search-input');
    const filterKeptBtn = document.getElementById('filter-kept');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalIframe = document.getElementById('modal-iframe');
    const modalSource = document.getElementById('modal-source');
    const modalActions = document.getElementById('modal-actions');
    const modalInfo = document.getElementById('modal-info');
    const modalClose = document.getElementById('modal-close');

    // =========================================
    // FETCH ALL CODES
    // =========================================
    async function fetchAllCodes(sort = 'recent') {
      try {
        const url = `${AC_BASE}/api/store-kidlisp?recent=true&limit=100000&sort=${sort}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.recent || [];
      } catch (err) {
        console.error('Failed to fetch codes:', err);
        return null;
      }
    }

    // =========================================
    // RENDER (paginated — renders PAGE_SIZE cards at a time)
    // =========================================
    function createCard(entry) {
      const card = document.createElement('div');
      card.className = 'keeps-card' + (entry.kept ? ' kept' : '');

      const when = entry.when ? new Date(entry.when) : null;
      const timeStr = when ? formatRelativeTime(when) : '';
      const handle = entry.handle || 'anon';
      const hits = entry.hits || 0;
      const isKept = !!entry.kept;

      // Build syntax-highlighted source with colored line numbers
      const sourceLines = (entry.source || '').split('\n');
      const lineNumsHtml = sourceLines.map((_, i) => `<span>${i + 1}</span>`).join('');
      const sourceTextHtml = highlightKidLisp(entry.source || '');

      // WebP preview image URL
      const webpUrl = `https://oven.aesthetic.computer/grab/webp/280/210/$${entry.code}?duration=2000&fps=8&quality=70&density=1&nowait=true`;

      card.innerHTML = `
        <div class="keeps-card-header">
          <a class="keeps-card-code" href="${KL_BASE}/$${entry.code}" title="Edit in KidLisp.com">$${entry.code}</a>
          <div class="keeps-card-meta">
            <span class="keeps-card-handle">${escapeHtml(handle)}</span>
            <span class="keeps-card-hits">${hits} hit${hits !== 1 ? 's' : ''}</span>
          </div>
        </div>
        <div class="keeps-card-preview">
          <div class="preview-noise"><div class="oven-label">oven</div><div class="oven-bar"></div></div>
          <img alt="$${entry.code} preview" loading="lazy" />
          <div class="preview-overlay"></div>
        </div>
        <div class="keeps-card-body">
          <div class="keeps-card-source"><div class="line-nums">${lineNumsHtml}</div><div class="source-text">${sourceTextHtml}</div></div>
        </div>
        <div class="keeps-card-actions">
          <button class="keeps-card-btn preview-btn" data-code="${entry.code}" title="Preview">&#x25B6; Preview</button>
          <a class="keeps-card-btn" href="${KL_BASE}/$${entry.code}" title="Open in editor">&#x270E; Edit</a>
          <a class="keeps-card-btn html-btn" href="${AC_BASE}/api/bundle-html?code=${entry.code}" target="_blank" title="Download as standalone HTML">&#x1F4E6; HTML</a>
          ${isKept ? `<span class="keeps-card-btn kept-badge" title="Kept on Tezos (Token #${entry.kept.tokenId || '?'})">&#x2714; Kept</span>` : ''}
          ${timeStr ? `<span style="margin-left: auto; font-size: 10px; color: var(--text-tertiary);">${timeStr}</span>` : ''}
        </div>`;

      // Set up animated noise placeholder
      const noiseEl = card.querySelector('.preview-noise');
      const { canvas, ctx, imageData } = createNoiseCanvas(56, 42);
      noiseEl.insertBefore(canvas, noiseEl.firstChild);
      const noiseId = startNoiseAnimation(canvas, ctx, imageData);

      // Load image with oven-style fallback
      const img = card.querySelector('.keeps-card-preview img');
      img.onload = () => {
        img.classList.add('loaded');
        clearInterval(noiseId);
        noiseEl.remove();
      };
      img.onerror = () => {
        // Keep noise placeholder visible — image not baked yet
      };
      img.src = webpUrl;

      // Click on preview area → open modal
      const previewArea = card.querySelector('.keeps-card-preview');
      previewArea.style.cursor = 'pointer';
      previewArea.addEventListener('click', () => openModal(entry));

      // Preview button handler
      card.querySelector('.preview-btn').addEventListener('click', () => openModal(entry));

      return card;
    }

    function renderGrid() {
      // Clear grid and reset pagination
      grid.innerHTML = '';
      renderedCount = 0;

      if (filteredCodes.length === 0) {
        grid.innerHTML = `
          <div class="keeps-error" style="grid-column: 1 / -1;">
            <div class="error-icon">&#x1F50D;</div>
            <div class="error-msg">${allCodes.length === 0 ? 'No $codes found.' : 'No matches for your search.'}</div>
            ${allCodes.length === 0 ? '<button class="retry-btn" onclick="init()">Retry</button>' : ''}
          </div>`;
        countEl.textContent = `0 of ${allCodes.length.toLocaleString()} $codes`;
        return;
      }

      // Render first batch
      renderMoreCards();
      countEl.textContent = `${filteredCodes.length.toLocaleString()} of ${allCodes.length.toLocaleString()} $codes`;
    }

    function renderMoreCards() {
      if (isLoadingMore || renderedCount >= filteredCodes.length) return;
      isLoadingMore = true;

      const frag = document.createDocumentFragment();
      const end = Math.min(renderedCount + PAGE_SIZE, filteredCodes.length);

      for (let i = renderedCount; i < end; i++) {
        frag.appendChild(createCard(filteredCodes[i]));
      }

      // Remove the "load more" sentinel if it exists
      const sentinel = document.getElementById('keeps-load-more');
      if (sentinel) sentinel.remove();

      grid.appendChild(frag);
      renderedCount = end;

      // Add a sentinel / "load more" trigger if there are more cards
      if (renderedCount < filteredCodes.length) {
        const loadMore = document.createElement('div');
        loadMore.id = 'keeps-load-more';
        loadMore.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-tertiary); font-size: 13px;';
        loadMore.textContent = `Showing ${renderedCount.toLocaleString()} of ${filteredCodes.length.toLocaleString()} — scroll for more`;
        grid.appendChild(loadMore);

        // Use IntersectionObserver to load more when sentinel is visible
        const observer = new IntersectionObserver((entries) => {
          if (entries[0].isIntersecting) {
            observer.disconnect();
            renderMoreCards();
          }
        }, { rootMargin: '200px' });
        observer.observe(loadMore);
      }

      isLoadingMore = false;
    }

    // =========================================
    // FILTER & SEARCH
    // =========================================
    function applyFilters() {
      const q = searchQuery.toLowerCase().trim();
      filteredCodes = allCodes.filter(entry => {
        // Kept filter
        if (showOnlyKept && !entry.kept) return false;

        // Search filter
        if (q) {
          const code = ('$' + entry.code).toLowerCase();
          const source = (entry.source || '').toLowerCase();
          const handle = (entry.handle || '').toLowerCase();
          if (!code.includes(q) && !source.includes(q) && !handle.includes(q)) return false;
        }

        return true;
      });
      renderGrid();
    }

    // =========================================
    // MODAL
    // =========================================
    function openModal(entry) {
      modalTitle.textContent = '$' + entry.code;

      // Syntax-highlighted source in modal sidebar
      const sourceLines = (entry.source || '(no source)').split('\n');
      const lineNumsHtml = sourceLines.map((_, i) => `<span>${i + 1}</span>`).join('');
      const sourceTextHtml = highlightKidLisp(entry.source || '(no source)');
      modalSource.innerHTML = `<div class="line-nums" style="flex-shrink:0;width:2.4em;text-align:right;padding-right:6px;user-select:none;border-right:1px solid var(--border-subtle);margin-right:6px;">${lineNumsHtml}</div><div style="flex:1;white-space:pre-wrap;word-break:break-word;">${sourceTextHtml}</div>`;
      modalSource.style.display = 'flex';

      // Load preview iframe
      const previewUrl = `${AC_BASE}/$${entry.code}`;
      modalIframe.src = previewUrl;

      // Build actions
      const handle = entry.handle || 'anon';
      const hits = entry.hits || 0;
      const when = entry.when ? new Date(entry.when) : null;

      let actionsHTML = `
        <a class="keeps-modal-action-btn edit-btn" href="${KL_BASE}/$${entry.code}" title="Open in KidLisp.com editor">&#x270E; Edit in KidLisp.com</a>
        <a class="keeps-modal-action-btn html-btn" href="${AC_BASE}/api/bundle-html?code=${entry.code}" target="_blank" title="Bundle as standalone HTML">&#x1F4E6; Download HTML Bundle</a>`;

      if (entry.kept) {
        actionsHTML += `<span class="keeps-modal-action-btn tezos-btn" style="cursor: default;">&#x2714; Kept on Tezos (Token #${entry.kept.tokenId || '?'})</span>`;
      } else {
        actionsHTML += `<a class="keeps-modal-action-btn tezos-btn" href="${AC_BASE}/keep~$${entry.code}" target="_blank" title="Keep this code on Tezos">&#x26D3; Keep on Tezos</a>`;
      }

      modalActions.innerHTML = actionsHTML;

      // Info
      let infoHTML = `<span><strong>Author:</strong> ${escapeHtml(handle)}</span>`;
      infoHTML += `<span><strong>Views:</strong> ${hits.toLocaleString()}</span>`;
      if (when) infoHTML += `<span><strong>Created:</strong> ${when.toLocaleDateString()} ${when.toLocaleTimeString()}</span>`;
      if (entry.kept) {
        infoHTML += `<span><strong>Network:</strong> ${entry.kept.network || 'mainnet'}</span>`;
        if (entry.kept.contractAddress) infoHTML += `<span><strong>Contract:</strong> ${entry.kept.contractAddress}</span>`;
      }
      modalInfo.innerHTML = infoHTML;

      modalOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modalOverlay.classList.remove('open');
      modalIframe.src = 'about:blank';
      document.body.style.overflow = '';
    }

    // =========================================
    // EVENT LISTENERS
    // =========================================

    // Search
    let searchDebounce;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        searchQuery = searchInput.value;
        applyFilters();
      }, 200);
    });

    // Kept filter toggle
    filterKeptBtn.addEventListener('click', () => {
      showOnlyKept = !showOnlyKept;
      filterKeptBtn.classList.toggle('active', showOnlyKept);
      applyFilters();
    });

    // Tab switching
    document.querySelectorAll('.keeps-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update active tab button
        document.querySelectorAll('.keeps-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update active tab content
        document.querySelectorAll('.keeps-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
      });
    });

    // Modal close
    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', e => {
      if (e.target === modalOverlay) closeModal();
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modalOverlay.classList.contains('open')) closeModal();
    });

    // =========================================
    // UTILITIES
    // =========================================
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Animated noise placeholder (oven-style)
    function createNoiseCanvas(width = 56, height = 42) {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const gray = Math.floor(Math.random() * 80) + 20;
        data[i] = gray;
        data[i + 1] = gray;
        data[i + 2] = gray + Math.floor(Math.random() * 20);
        data[i + 3] = 255;
      }
      ctx.putImageData(imageData, 0, 0);
      return { canvas, ctx, imageData };
    }

    function startNoiseAnimation(canvas, ctx, imageData, interval = 180) {
      const data = imageData.data;
      const id = setInterval(() => {
        for (let i = 0; i < data.length; i += 4) {
          const gray = Math.floor(Math.random() * 80) + 20;
          data[i] = gray;
          data[i + 1] = gray;
          data[i + 2] = gray + Math.floor(Math.random() * 20);
          data[i + 3] = 255;
        }
        ctx.putImageData(imageData, 0, 0);
      }, interval);
      return id;
    }

    // Lightweight KidLisp syntax highlighter
    const KL_SPECIAL = new Set(['def', 'if', 'cond', 'later', 'once', 'lambda', 'let', 'do', 'repeat']);
    const KL_OPS = new Set(['+', '-', '*', '/', '%', 'mod', '=', '>', '<', '>=', '<=', 'abs', 'sqrt', 'min', 'max']);
    const KL_FNS = new Set([
      'line', 'box', 'circle', 'write', 'paste', 'stamp', 'ink', 'wipe', 'flood',
      'scroll', 'zoom', 'blur', 'contrast', 'spin', 'draw', 'wiggle', 'pan', 'jump',
      'grid', 'noise', 'sin', 'cos', 'rand', 'floor', 'ceil', 'round', 'log',
      'list', 'nth', 'len', 'push', 'pop', 'map', 'filter', 'reduce', 'apply',
      'print', 'type', 'str', 'num', 'not', 'and', 'or', 'true', 'false',
      'pixel', 'plot', 'poly', 'ellipse', 'rect', 'tri', 'quad', 'arc',
      'color', 'opacity', 'scale', 'rotate', 'translate', 'move', 'goto',
      'sound', 'synth', 'wave', 'freq', 'vol', 'note', 'beat', 'bpm',
      'load', 'save', 'fetch', 'delay', 'every', 'after',
    ]);

    function highlightKidLisp(source) {
      // Tokenize using a regex that matches comments, strings, parens, whitespace, and words
      const tokenRegex = /(;[^\n]*|"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'|[()[\],]|\s+|[^\s()[\],"';]+)/g;
      let result = '';
      let match;
      while ((match = tokenRegex.exec(source)) !== null) {
        const tok = match[1];
        if (tok.startsWith(';')) {
          result += `<span class="kl-comment">${escapeHtml(tok)}</span>`;
        } else if (tok.startsWith('"') || tok.startsWith("'")) {
          result += `<span class="kl-string">${escapeHtml(tok)}</span>`;
        } else if (/^\s+$/.test(tok)) {
          result += tok;
        } else if (tok === '(' || tok === ')' || tok === '[' || tok === ']' || tok === ',') {
          result += `<span class="kl-paren">${tok}</span>`;
        } else if (/^-?\d+(\.\d+)?$/.test(tok) || /^\d*\.?\d+[sf]!?$/.test(tok) || /^\d*\.?\d+[sf]\.\.\.?$/.test(tok)) {
          result += `<span class="kl-number">${escapeHtml(tok)}</span>`;
        } else if (/^[$#!][0-9A-Za-z]+$/.test(tok)) {
          result += `<span class="kl-code-ref">${escapeHtml(tok)}</span>`;
        } else if (KL_SPECIAL.has(tok)) {
          result += `<span class="kl-special">${escapeHtml(tok)}</span>`;
        } else if (KL_OPS.has(tok)) {
          result += `<span class="kl-op">${escapeHtml(tok)}</span>`;
        } else if (KL_FNS.has(tok)) {
          result += `<span class="kl-fn">${escapeHtml(tok)}</span>`;
        } else {
          result += `<span class="kl-var">${escapeHtml(tok)}</span>`;
        }
      }
      return result;
    }

    function formatRelativeTime(date) {
      const now = Date.now();
      const diff = now - date.getTime();
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      const months = Math.floor(days / 30);
      const years = Math.floor(days / 365);

      if (seconds < 60) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 30) return `${days}d ago`;
      if (months < 12) return `${months}mo ago`;
      return `${years}y ago`;
    }

    // =========================================
    // INIT
    // =========================================
    async function init() {
      loading.style.display = 'flex';
      grid.innerHTML = '';
      grid.appendChild(loading);

      const codes = await fetchAllCodes();
      loading.style.display = 'none';

      if (codes === null) {
        grid.innerHTML = `
          <div class="keeps-error" style="grid-column: 1 / -1;">
            <div class="error-icon">&#x26A0;</div>
            <div class="error-msg">Failed to load $codes. Check your connection and try again.</div>
            <button class="retry-btn" onclick="init()">Retry</button>
          </div>`;
        return;
      }

      allCodes = codes;
      filteredCodes = codes;
      countEl.textContent = `${codes.length.toLocaleString()} $codes`;
      renderGrid();

      // Populate floating castle $codes with real ones
      const floaters = document.querySelectorAll('.keeps-code-float');
      if (codes.length >= floaters.length) {
        const shuffled = [...codes].sort(() => Math.random() - 0.5);
        floaters.forEach((el, i) => { el.textContent = '$' + shuffled[i].code; });
      }

      // Handle ?q= search param
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('q')) {
        searchInput.value = urlParams.get('q');
        searchQuery = urlParams.get('q');
        applyFilters();
      }
      if (urlParams.has('kept')) {
        showOnlyKept = true;
        filterKeptBtn.classList.add('active');
        applyFilters();
      }
    }

    init();
  </script>
</body>
</html>
