<h1 id="pitch"></h1>

<script
  src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2.9/dist/tf.min.js"></script>
<script>
  const NUM_INPUT_SAMPLES = 256;
  const MODEL_SAMPLE_RATE = 16000;
  const PT_OFFSET = 25.58;
  const PT_SLOPE = 63.07;
  const CONF_THRESHOLD = 0;
  const MODEL_URL = 'https://tfhub.dev/google/tfjs-model/spice/2/default/1';
  let model;

  function getPitchHz(modelPitch) {
    const fmin = 10.0;
    const bins_per_octave = 12.0;
    const cqt_bin = modelPitch * PT_SLOPE + PT_OFFSET;
    return fmin * Math.pow(2.0, (1.0 * cqt_bin / bins_per_octave));
  }

  async function startDemo() {
    await tf.setBackend('webgl');
    model = await tf.loadGraphModel(MODEL_URL, { fromTFHub: true });

    const audioContext = new AudioContext({
      latencyHint: "playback",
      sampleRate: MODEL_SAMPLE_RATE,
    });

    const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    const source = audioContext.createMediaStreamSource(mediaStream);

    await audioContext.audioWorklet.addModule('spice-processor.js');
    const audioWorkletNode = new AudioWorkletNode(audioContext, 'spice-processor');
    source.connect(audioWorkletNode);
    audioWorkletNode.connect(audioContext.destination);

    let processing = false;

    audioWorkletNode.port.onmessage = async (event) => {
      if (processing) {
        console.log("Skipped processing a frame...");
        return;
      }
      processing = true;
      processSamples(event.data);
    };

    async function processSamples(samples) {
      const inputData = samples; // Replace this with your processing logic
      const input = tf.reshape(tf.tensor(inputData), [NUM_INPUT_SAMPLES]);
      const output = model.execute({ "input_audio_samples": input });
      const uncertainties = await output[0].data();
      const pitches = await output[1].data();
      for (let i = 0; i < pitches.length; ++i) {
        let confidence = 1.0 - uncertainties[i];
        if (confidence < CONF_THRESHOLD) continue;
        document.querySelector("#pitch").innerHTML = `Pitch: ${getPitchHz(pitches[i])}`;
      }
      processing = false;
    }

  }

  // This needs a microphone to work, check for exceptions.
  // startDemo();
  window.onclick = startDemo;
</script>

<p>Click to start.</p>