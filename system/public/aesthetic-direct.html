<!--
Aesthetic Direct, 24.10.19.22.43
Corportate updates from Aesthetic Computer.

#region 🏁 TODO
  - [-] Add endpoint to show live 'metrics' / stats on the platform.
    - [] Account Signups:  via auth0
    - [] Handles registered: 
    - [] Other database fields. 
  WIP
  - [] Write and date an initial message that...
    - [] Announces the corporation and links the papers.
    - [] Honors and thanks the booted-by patrons.
    - [] Include a path to converting early patrons into SAFE holders.
  - [] Announcing "Aesthetic Inc."
    - [] The cultural, creative, and financial significance of Aesthetic Computer.
  - [] Valuating Aesthetic Computer.
  + Done
  - [x] Add 'Track changes to this page.' link on the bottom.
#endregion 
-->

<html>

<head>
  <title>Aesthetic Direct</title>
  <meta name="description" content="Corporate updates from Aesthetic Computer." />
  <style>
    body {
      font-family: sans-serif;
      background-color: rgb(235, 235, 235);
      opacity: 1;
      -webkit-text-size-adjust: none;
    }

    #wrapper {
      opacity: 1;
      transition: opacity 0.5s;
    }

    #wrapper.fetching {
      opacity: 0;
    }

    code {
      font-weight: bold;
    }

    #report-card-wrapper {
      background: rgb(245, 245, 235);
      width: 300px;
      aspect-ratio: 8/10;
      margin: 0.5em;
      border: 2px solid;
      border-radius: 8px;
      overflow: hidden;
    }

    #report-card {
      background: rgb(255, 255, 230);
      display: flex;
      aspect-ratio: 8/10;
      font-size: 16px;
      width: 300px;
      transition: opacity 0.25s;
      opacity: 1;
      flex-direction: column;
      position: relative;
    }

    #report-card.fetching {
      opacity: 0;
    }

    #report-card sub.fail {
      display: block;
      color: red;
      margin: auto;
    }

    #report-card-title {
      /* background: tan; */
      font-family: serif;
      text-align: center;
      top: 5%;
      width: 100%;
      position: absolute;
      font-size: 1.5em;
    }

    #report-card-timestamp {
      /* background: cyan; */
      font-family: serif;
      text-align: center;
      top: calc(5% + 1.85em);
      width: 100%;
      position: absolute;
    }

    #report-card-marks {
      background: yellow;
      font-family: monospace;
      font-size: 75%;
      top: calc(5% + 5em);
      padding: 0em 2em;
      width: 100%;
      position: absolute;
    }

    a#edited {
      color: blue;
    }
  </style>
  <link rel="icon" type="image/png"
    href="https://pals-aesthetic-computer.sfo3.cdn.digitaloceanspaces.com/painting-2023.7.29.20.39.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <div id="wrapper" class="fetching">
    <h1>Aesthetic Direct</h1>
    <p>
    </p>
    <div id="report-card-wrapper">
      <div id="report-card" class="fetching">
        <div id="report-card-title">AC Report Card</div>
        <div id="report-card-timestamp"></div>
        <div id="report-card-marks"></div>
      </div>
    </div>
    <a href="/"><img width="128"
        src="https://pals-aesthetic-computer.sfo3.cdn.digitaloceanspaces.com/painting-2023.7.29.20.39.png"></a>
    <br>
    <br>
    <sub><a id="edited"
        href="https://github.com/whistlegraph/aesthetic-computer/commits/main/system/public/aesthetic-direct.html">Edited
        on October 19, 2024</a></sub>
  </div>

  <script type="module">
    // Get live metrics.
    const reportCard = document.getElementById("report-card");
    const reportCardMarks = document.getElementById("report-card-marks");
    const reportCardTimestamp = document.getElementById("report-card-timestamp");
    const wrapper = document.getElementById("wrapper");
    const fail = '<sub class="fail">Could not retrieve metrics.</sub>';
    setTimeout(() => {
      wrapper.classList.remove("fetching");
    }, 0);
    try {
      const response = await fetch('/api/metrics');
      if (response.status === 200) {
        const data = await response.json();

        // TODO: 🔵 Generate elements for stats items here. 24.10.20.05.29
        // reportCardMarks.innerHTML = //JSON.stringify(data, null, 2);

        const activeUsers = document.createElement("div");
        activeUsers.innerText = "Monthly active users: " + data.active;

        reportCardMarks.appendChild(activeUsers);

        const now = data.time;
        reportCardTimestamp.innerText = now;

        reportCard.classList.remove('fetching');
      } else {
        reportCard.innerHTML = fail;
      }
    } catch (error) {
      reportCard.innerHTML = fail;
    }
  </script>

  <!-- Development reload logic. -->
  <script>
    let reconnectInterval = false;
    function connect() {
      clearInterval(reconnectInterval);
      let ws;
      try {
        let connectionUrl = "wss://localhost:8889";
        if (window.location.host === "local.aesthetic.computer") {
          connectionUrl = "wss://session.local.aesthetic.computer";
        }
        ws = new WebSocket(connectionUrl);
      } catch {
        console.warn("🧦 Connection failed.");
        return;
      }

      // ws.onopen = (e) => console.log("🧦 Connected:", e);

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "reload" && msg.content.piece === "*refresh*") {
          setTimeout(() => {
            console.log("🧦 Reloading...");
            const url = new URL(window.location.href);
            window.location.href = url.toString();
          }, 150); // Wait a sec for backend functions to reload.
        }
      };

      ws.onclose = (e) => {
        // console.log("🧦 🔴 Closed:", e);
        reconnectInterval = setInterval(connect, 1000);
      };
    }
    connect();
  </script>
</body>

</html>