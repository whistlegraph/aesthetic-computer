var O="0.0.7";var w=class{fn;context;once;constructor(e,n,t=!1){this.fn=e,this.context=n,this.once=t}},P=(r,e,n,t,s)=>{if(typeof n!="function")throw new TypeError("The listener must be a function");let o=new w(n,t||r,s);return r._events.has(e)?r._events.get(e).fn?r._events.set(e,[r._events.get(e),o]):r._events.get(e).push(o):(r._events.set(e,o),r._eventsCount++),r},g=(r,e)=>{--r._eventsCount===0?r._events=new Map:r._events.delete(e)},C=class{static get VERSION(){return O}_events=new Map;_eventsCount=0;eventNames(){return Array.from(this._events.keys())}listeners(e){let n=this._events.get(e);if(!n)return[];if(n.fn)return[n.fn];for(var t=0,s=n.length,o=new Array(s);t<s;t++)o[t]=n[t].fn;return o}listenerCount(e){let n=this._events.get(e);return n?n.fn?1:n.length:0}emit(e,...n){if(!this._events.has(e))return!1;let t=this._events.get(e),s;if(t.fn)return t.once&&this.removeListener(e,t.fn,void 0,!0),t.fn.call(t.context,...n),!0;{let o=t.length;for(s=0;s<o;s++)t[s].once&&this.removeListener(e,t[s].fn,void 0,!0),t[s].fn.call(t[s].context,...n)}return!0}on(e,n,t){return P(this,e,n,t,!1)}once(e,n,t){return P(this,e,n,t,!0)}removeListener(e,n,t,s){if(!this._events.has(e))return this;if(!n)return g(this,e),this;let o=this._events.get(e);if(o.fn)o.fn===n&&(!s||o.once)&&(!t||o.context===t)&&g(this,e);else{for(var i=0,c=[],h=o.length;i<h;i++)(o[i].fn!==n||s&&!o[i].once||t&&o[i].context!==t)&&c.push(o[i]);c.length?this._events.set(e,c.length===1?c[0]:c):g(this,e)}return this}removeAllListeners(e){return e?this._events.delete(e)&&g(this,e):(this._events=new Map,this._eventsCount=0),this}get off(){return this.removeListener}get addListener(){return this.on}};var d=class{constructor(){this.eventEmitter=new C}emit(e,n,t={}){this.eventEmitter.emit(e,n,t)}on(e,n){return this.eventEmitter.on(e,(t,s)=>{n(t,s)})}removeAllListeners(){this.eventEmitter.removeAllListeners()}},W=new d;var l={CONNECT:"connect",CONNECTION:"connection",DATA_CHANNEL_IS_OPEN:"dataChannelIsOpen",DISCONNECT:"disconnect",DISCONNECTED:"disconnected",DROP:"dropped",ERROR:"error",RAW_MESSAGE:"rawMessage",RECEIVED_FROM_DATA_CHANNEL:"receiveFromDataChannel",SEND_OVER_DATA_CHANNEL:"sendOverDataChannel"},S={BROWSER_NOT_SUPPORTED:"BROWSER_NOT_SUPPORTED",COULD_NOT_PARSE_MESSAGE:"COULD_NOT_PARSE_MESSAGE",DROPPED_FROM_BUFFERING:"DROPPED_FROM_BUFFERING",MAX_MESSAGE_SIZE_EXCEEDED:"MAX_MESSAGE_SIZE_EXCEEDED"};var T=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;var X=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,_=r=>typeof r=="string",p=r=>r instanceof ArrayBuffer||r instanceof T,D=r=>{try{return typeof r!="string"||!isNaN(parseInt(r))?!1:(JSON.parse(r),!0)}catch{return!1}};var y=r=>{let{data:e}=r;e||(e=r);let n=p(e),t=D(e),s=_(e);if(t){let o=JSON.parse(e),i=Object.keys(o)[0],c=o[i];return{key:i,data:c}}return n?{key:l.RAW_MESSAGE,data:e}:s?{key:l.RAW_MESSAGE,data:e}:{key:"error",data:new Error(S.COULD_NOT_PARSE_MESSAGE)}};var A=(r,e,n,t=null)=>{var s;let o=(i,c)=>{var h;let a=(h=i.byteLength)!==null&&h!==void 0?h:i.length*2;if(typeof e=="number"&&a>e)throw new Error(`maxMessageSize of ${e} exceeded`);Promise.resolve().then(()=>{r.send?r.send(i):c?r.sendMessageBinary(Buffer.from(i)):r.sendMessage(i)}).catch(f=>{console.log("error",f)})};if(r&&(r.readyState==="open"||!((s=r.isOpen)===null||s===void 0)&&s.call(r)))try{n===l.RAW_MESSAGE&&t!==null&&(_(t)||p(t))?o(t,p(t)):o(JSON.stringify({[n]:t}),!1)}catch(i){return console.error("Error in sendMessage.ts: ",i.message),i}};var m=class{emit(e,n=null){A(this.dataChannel,this.maxMessageSize,e,n)}constructor(e,n,t,s){this.url=e,this.authorization=n,this.label=t,this.rtcConfiguration=s,this.bridge=new d,this.onDataChannel=o=>{let{channel:i}=o;i.label===this.label&&(this.dataChannel=i,this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=c=>{let{key:h,data:a}=y(c);this.bridge.emit(h,a)})}}async fetchAdditionalCandidates(e,n){var t;if(((t=this.dataChannel)===null||t===void 0?void 0:t.readyState)==="closed")return;let s=await fetch(`${e}/connections/${n}/additional-candidates`,{method:"GET",headers:{"Content-Type":"application/json"}});s.ok&&(await s.json()).forEach(i=>{this.localPeerConnection.addIceCandidate(i)})}async connect(){let e=`${this.url}/.wrtc/v2`,n={"Content-Type":"application/json"};this.authorization&&(n={...n,Authorization:this.authorization});let t={};try{let a=await fetch(`${e}/connections`,{method:"POST",headers:n});if(a.status>=300)throw{name:"Error",message:`Connection failed with status code ${a.status}.`,status:a.status,statusText:a.statusText};let f=await a.json();t=f.userData,this.remotePeerConnection=f}catch(a){return console.error(a.message),{error:a}}let{id:s,localDescription:o}=this.remotePeerConnection,i={sdpSemantics:"unified-plan",...this.rtcConfiguration},c=RTCPeerConnection||webkitRTCPeerConnection;this.localPeerConnection=new c(i),((a=10,f=50,R=1.8,u=20)=>Array(a).fill(0).map((B,L)=>parseInt((f*R**L).toString())+parseInt((Math.random()*u).toString())))().forEach(a=>{setTimeout(()=>{this.fetchAdditionalCandidates(e,s).catch(()=>{})},a)});try{await this.localPeerConnection.setRemoteDescription(o),this.localPeerConnection.addEventListener("datachannel",this.onDataChannel,{once:!0});let a=await this.localPeerConnection.createAnswer(),f=new RTCSessionDescription({type:"answer",sdp:a.sdp});await this.localPeerConnection.setLocalDescription(f);try{await fetch(`${e}/connections/${s}/remote-description`,{method:"POST",body:JSON.stringify(this.localPeerConnection.localDescription),headers:{"Content-Type":"application/json"}})}catch(u){return console.error(u.message),{error:u}}let R=()=>new Promise(u=>{this.localPeerConnection.addEventListener("datachannel",()=>{u()},{once:!0})});return this.dataChannel||await R(),{userData:t,localPeerConnection:this.localPeerConnection,dataChannel:this.dataChannel,id:s}}catch(a){return console.error(a.message),this.localPeerConnection.close(),{error:a}}}};var E=class{async connect(e){if(RTCPeerConnection||webkitRTCPeerConnection){let{localPeerConnection:t,dataChannel:s,id:o,userData:i,error:c}=await e.connect();return c?{error:c}:!t||!s||!o||!i?{error:new Error('Something went wrong in "await connectionsManager.connect()"')}:(this.localPeerConnection=t,this.dataChannel=s,this.id=o,{userData:i})}else{let t=new Error(S.BROWSER_NOT_SUPPORTED);return console.error(t.message),{error:t}}}};var v=(r=24)=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(let t=0;t<r;t++)n+=e.charAt(Math.floor(Math.random()*e.length));return n};var N=(r=200,e=1,n)=>{let t=0;if(typeof n!="function"){console.error("You have to define your callback function!");return}let s=setInterval(()=>{n(),t++,t===e-1&&clearInterval(s)},r);n()};var b=(r,e)=>{let{interval:n=150,runs:t=10}=r,s=v(24);N(n,t,()=>{e(s)})};var M=class{constructor(e,n,t,s,o){this.userData={},this.receivedReliableMessages=[],this.url=t?`${e}:${t}`:e,this.connectionsManager=new m(this.url,n,s,o),this.bridge=this.connectionsManager.bridge,this.bridge.on(l.DISCONNECTED,()=>this.bridge.removeAllListeners())}onconnectionstatechange(){let e=this.peerConnection.localPeerConnection;e.onconnectionstatechange=()=>{(e.connectionState==="disconnected"||e.connectionState==="closed")&&this.bridge.emit(l.DISCONNECTED)}}get id(){return this.peerConnection.id}close(){this.peerConnection.localPeerConnection.close(),this.bridge.emit(l.DISCONNECTED);try{let e=`${this.url}/.wrtc/v2`;fetch(`${e}/connections/${this.id}/close`,{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.error(e.message)}}emit(e,n=null,t){t&&t.reliable?b(t,s=>this.connectionsManager.emit(e,{MESSAGE:n,RELIABLE:1,ID:s})):this.connectionsManager.emit(e,n)}get raw(){return{emit:e=>this.emit(l.RAW_MESSAGE,e)}}onRaw(e){this.bridge.on(l.RAW_MESSAGE,n=>{(s=>e(s))(n)})}async onConnect(e){var n;this.peerConnection=new E;let t=await this.peerConnection.connect(this.connectionsManager);t.error?e(t.error):(t.userData&&(this.userData=t.userData),this.maxMessageSize=this.connectionsManager.maxMessageSize=(n=this.peerConnection.localPeerConnection.sctp)===null||n===void 0?void 0:n.maxMessageSize,this.onconnectionstatechange(),e())}onDisconnect(e){this.bridge.on(l.DISCONNECTED,e)}on(e,n){this.bridge.on(e,t=>{t&&t.RELIABLE===1&&t.ID!=="undefined"?((()=>{let c=new Date().getTime();this.receivedReliableMessages.forEach((h,a,f)=>{h.expire<=c&&f.splice(a,1)})})(),this.receivedReliableMessages.filter(c=>c.id===t.ID).length===0&&(this.receivedReliableMessages.push({id:t.ID,timestamp:new Date,expire:new Date().getTime()+15e3}),n(t.MESSAGE))):n(t)})}},k=(r={})=>{let{authorization:e=void 0,iceServers:n=[],iceTransportPolicy:t="all",label:s="geckos.io",port:o=9208,url:i=`${location.protocol}//${location.hostname}`}=r;return new M(i,e,o,s,{iceServers:n,iceTransportPolicy:t})},x=k;var I=x;var _e=I;export{_e as default};
/*! Bundled license information:

@yandeu/events/lib/index.js:
  (**
   * @package      npmjs.com/package/@yandeu/events (events.min.js)
   *
   * @author       Arnout Kazemier (https://github.com/3rd-Eden)
   * @copyright    Copyright (c) 2014 Arnout Kazemier
   * @license      {@link https://github.com/primus/eventemitter3/blob/master/LICENSE|MIT}
   *
   * @author       Yannick Deubel (https://github.com/yandeu)
   * @copyright    Copyright (c) 2021 Yannick Deubel; Project Url: https://github.com/yandeu/events
   * @license      {@link https://github.com/yandeu/events/blob/master/LICENSE|MIT}
   *)
*/
