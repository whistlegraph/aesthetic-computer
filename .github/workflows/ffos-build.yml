name: Build FFOS (Aesthetic Computer OS)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version'
        required: true
        default: '1.0.0'
      ffos_branch:
        description: 'FFOS repo branch'
        required: true
        default: 'develop'
      ffos_user_branch:
        description: 'FFOS-USER repo branch'
        required: true
        default: 'develop'

jobs:
  build-iso:
    name: Build Arch Linux ISO
    runs-on: ubuntu-latest
    timeout-minutes: 60

    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            archiso arch-install-scripts dosfstools libisoburn squashfs-tools \
            git curl rsync sudo base-devel jq zip unzip fakeroot binutils \
            go rust syslinux

      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Clone FFOS repos
        run: |
          mkdir -p /work
          git clone --branch ${{ inputs.ffos_branch }} --depth 1 \
            https://github.com/feral-file/ffos.git /work/ffos
          git clone --branch ${{ inputs.ffos_user_branch }} --depth 1 \
            https://github.com/feral-file/ffos-user.git /work/ffos-user

      - name: Apply local overlays
        run: |
          OVERLAYS="$GITHUB_WORKSPACE/utilities/ffos-build/overlays"
          if [ -d "$OVERLAYS/ffos-user" ]; then
            echo "üìù Applying ffos-user overlays..."
            rsync -av "$OVERLAYS/ffos-user/" /work/ffos-user/
          fi

      - name: Build Go components
        run: |
          VERSION="${{ inputs.version }}"
          COMPONENTS_DIR=/work/ffos-user/components
          LOCAL_REPO=/work/local-repo
          mkdir -p "$LOCAL_REPO"
          chown -R builder:builder "$LOCAL_REPO"

          for comp in feral-controld feral-sys-monitord feral-watchdog; do
            echo "=== Building $comp ==="
            cd "$COMPONENTS_DIR/$comp"
            CGO_ENABLED=0 go build -buildvcs=false -ldflags="-s -w" -o "/tmp/$comp" .

            BUILDDIR="/tmp/build-$comp"
            mkdir -p "$BUILDDIR"
            cp "/tmp/$comp" "$BUILDDIR/"

            cat > "$BUILDDIR/PKGBUILD" << PKGBUILD
          pkgname=$comp
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Feral File $comp daemon"
          arch=("x86_64")
          license=("MIT")
          depends=()
          source=("$comp")
          sha256sums=("SKIP")

          package() {
            install -Dm755 "\$srcdir/$comp" "\$pkgdir/usr/bin/$comp"
          }
          PKGBUILD

            chown -R builder:builder "$BUILDDIR"
            cd "$BUILDDIR"
            sudo -u builder makepkg -f --nodeps --skipinteg
            mv *.pkg.tar.* "$LOCAL_REPO/"
            echo "‚úÖ Built $comp"
          done

      - name: Build Rust component (feral-setupd)
        run: |
          VERSION="${{ inputs.version }}"
          LOCAL_REPO=/work/local-repo
          COMPONENTS_DIR=/work/ffos-user/components

          cd "$COMPONENTS_DIR/feral-setupd"
          cargo build --release 2>/dev/null || echo "‚ö†Ô∏è Rust build failed, creating stub"

          BINARY=$(find target/release -maxdepth 1 -type f -executable -name "feral*" 2>/dev/null | head -1)
          if [ -z "$BINARY" ] || [ ! -f "$BINARY" ]; then
            echo "Creating stub for feral-setupd..."
            echo '#!/bin/bash' > /tmp/feral-setupd
            echo 'echo feral-setupd stub' >> /tmp/feral-setupd
            chmod +x /tmp/feral-setupd
            BINARY=/tmp/feral-setupd
          fi

          BUILDDIR="/tmp/build-feral-setupd"
          mkdir -p "$BUILDDIR"
          cp "$BINARY" "$BUILDDIR/feral-setupd"

          cat > "$BUILDDIR/PKGBUILD" << PKGBUILD
          pkgname=feral-setupd
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Feral File setup daemon"
          arch=("x86_64")
          license=("MIT")
          depends=()
          source=("feral-setupd")
          sha256sums=("SKIP")

          package() {
            install -Dm755 "\$srcdir/feral-setupd" "\$pkgdir/usr/bin/feral-setupd"
          }
          PKGBUILD

          chown -R builder:builder "$BUILDDIR"
          cd "$BUILDDIR"
          sudo -u builder makepkg -f --nodeps --skipinteg
          mv *.pkg.tar.* "$LOCAL_REPO/"
          echo "‚úÖ Built feral-setupd"

      - name: Set up local pacman repo
        run: |
          cd /work/local-repo
          ls -la *.pkg.tar.*
          repo-add ac-local.db.tar.gz *.pkg.tar.*

      - name: Prepare archiso profile
        run: |
          VERSION="${{ inputs.version }}"
          OVERLAYS="$GITHUB_WORKSPACE/utilities/ffos-build/overlays"
          LOCAL_REPO=/work/local-repo
          PROFILE=/work/archiso-profile

          cp -r /work/ffos/archiso-ff1 "$PROFILE"
          printf "\n" >> "$PROFILE/packages.x86_64"

          if [ -f "$OVERLAYS/ffos/archiso-ff1/packages.x86_64.append" ]; then
            echo "=== Appending overlay packages ==="
            cat "$OVERLAYS/ffos/archiso-ff1/packages.x86_64.append" >> "$PROFILE/packages.x86_64"
          fi

          # Add BIOS + UEFI boot support
          sed -i "s/bootmodes=.*/bootmodes=('bios.syslinux.mbr' 'bios.syslinux.eltorito' 'uefi-x64.systemd-boot.esp' 'uefi-x64.systemd-boot.eltorito')/" "$PROFILE/profiledef.sh"

          # Use zstd compression (avoids xz corruption on CI runners)
          sed -i "s/airootfs_image_tool_options=.*/airootfs_image_tool_options=('-comp' 'zstd' '-Xcompression-level' '19' '-b' '1M')/" "$PROFILE/profiledef.sh"
          echo "syslinux" >> "$PROFILE/packages.x86_64"

          mkdir -p "$PROFILE/syslinux"
          cat > "$PROFILE/syslinux/syslinux.cfg" << 'SYSLINUX'
          DEFAULT arch
          PROMPT 0
          TIMEOUT 50
          LABEL arch
              LINUX ../boot/x86_64/vmlinuz-linux
              INITRD ../boot/x86_64/initramfs-linux.img
              APPEND archisobasedir=arch archisolabel=ARCH_FFOS
          SYSLINUX

          # Add local repo to pacman.conf
          printf '\n[ac-local]\nSigLevel = Optional TrustAll\nServer = file://%s\n' "$LOCAL_REPO" >> "$PROFILE/pacman.conf"

          # Merge ffos-user data into airootfs
          mkdir -p "$PROFILE/airootfs/home"
          rsync -a /work/ffos-user/users/ "$PROFILE/airootfs/home/"

      - name: Install systemd services and hardening
        run: |
          PROFILE=/work/archiso-profile

          echo "=== Installing system-level services ==="
          mkdir -p "$PROFILE/airootfs/etc/systemd/system"
          SERVICES_SRC="$PROFILE/airootfs/home/feralfile/systemd-services"
          if [ -d "$SERVICES_SRC" ]; then
            for svc in feral-controld feral-sys-monitord feral-watchdog feral-setupd; do
              if [ -f "$SERVICES_SRC/${svc}.service" ]; then
                cp "$SERVICES_SRC/${svc}.service" "$PROFILE/airootfs/etc/systemd/system/"
                mkdir -p "$PROFILE/airootfs/etc/systemd/system/multi-user.target.wants"
                ln -sf "/etc/systemd/system/${svc}.service" \
                  "$PROFILE/airootfs/etc/systemd/system/multi-user.target.wants/${svc}.service"
                echo "Installed: ${svc}.service"
              fi
            done
          fi

          echo "=== Installing user-level services ==="
          mkdir -p "$PROFILE/airootfs/home/feralfile/.config/systemd/user/default.target.wants"
          for svc in aesthetic-kiosk; do
            if [ -f "$PROFILE/airootfs/home/feralfile/.config/systemd/user/${svc}.service" ]; then
              ln -sf "/home/feralfile/.config/systemd/user/${svc}.service" \
                "$PROFILE/airootfs/home/feralfile/.config/systemd/user/default.target.wants/${svc}.service"
              echo "Enabled user service: ${svc}.service"
            fi
          done

          echo "=== Creating feralfile user ==="
          echo "feralfile:x:1000:1000:Feral File:/home/feralfile:/bin/bash" >> "$PROFILE/airootfs/etc/passwd"
          echo "feralfile:x:1000:" >> "$PROFILE/airootfs/etc/group"
          echo "feralfile:!:19000:0:99999:7:::" >> "$PROFILE/airootfs/etc/shadow"

          echo "=== Auto-login feralfile on TTY1 ==="
          mkdir -p "$PROFILE/airootfs/etc/systemd/system/getty@tty1.service.d"
          cat > "$PROFILE/airootfs/etc/systemd/system/getty@tty1.service.d/autologin.conf" << 'AUTOLOGIN'
          [Service]
          ExecStart=
          ExecStart=-/usr/bin/agetty --noclear --autologin feralfile %I $TERM
          AUTOLOGIN

          echo "=== Hardening feral-sys-monitord ==="
          if [ -f "$PROFILE/airootfs/etc/systemd/system/feral-sys-monitord.service" ]; then
            cat > "$PROFILE/airootfs/etc/systemd/system/feral-sys-monitord.service" << 'SYSMON'
          [Unit]
          Description=Feral File System Monitord (hardened)
          After=network.target dbus.service systemd-logind.service user@1000.service
          Wants=dbus.service user@1000.service
          StartLimitBurst=10
          StartLimitIntervalSec=300

          [Service]
          Type=simple
          User=feralfile
          Group=feralfile
          Environment="DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus"
          Environment="XDG_RUNTIME_DIR=/run/user/1000"
          ExecStartPre=/bin/bash -c 'n=0; while [ $n -lt 60 ]; do [ -S /run/user/1000/bus ] && exit 0; n=$((n+1)); sleep 1; done; echo WARN: D-Bus session bus not found after 60s >&2'
          ExecStart=/usr/bin/feral-sys-monitord
          Restart=always
          RestartSec=5
          StandardOutput=append:/home/feralfile/.logs/sys-monitord.log
          StandardError=append:/home/feralfile/.logs/sys-monitord.log

          [Install]
          WantedBy=multi-user.target
          SYSMON
          fi

          echo "=== Hardened system presets ==="
          mkdir -p "$PROFILE/airootfs/etc/systemd/system-preset"
          cat > "$PROFILE/airootfs/etc/systemd/system-preset/90-ac-hardened.preset" << 'PRESET'
          enable sshd.service
          enable bluetooth.service
          enable NetworkManager.service
          enable systemd-networkd.service
          enable systemd-resolved.service
          enable seatd.service
          enable getty@tty1.service
          PRESET

      - name: Create customize_airootfs.sh
        run: |
          PROFILE=/work/archiso-profile
          cat > "$PROFILE/airootfs/root/customize_airootfs.sh" << 'CUSTOMIZE'
          #!/bin/bash
          set -e
          echo "=== AC Hardened customize_airootfs.sh ==="

          mkdir -p /home/feralfile/.logs /home/feralfile/.state /home/feralfile/.config
          chown -R feralfile:feralfile /home/feralfile

          mkdir -p /var/lib/systemd/linger
          touch /var/lib/systemd/linger/feralfile

          mkdir -p /run/user/1000
          chown feralfile:feralfile /run/user/1000
          chmod 700 /run/user/1000

          mkdir -p /etc/polkit-1/rules.d
          cat > /etc/polkit-1/rules.d/90-nmcli-feralfile.rules << 'POLKIT'
          polkit.addRule(function(action, subject) {
              if (action.id.indexOf("org.freedesktop.NetworkManager") === 0 &&
                  subject.user === "feralfile") {
                  return polkit.Result.YES;
              }
          });
          POLKIT

          systemctl enable NetworkManager.service 2>/dev/null || true
          systemctl enable sshd.service 2>/dev/null || true
          systemctl enable seatd.service 2>/dev/null || true
          systemctl enable bluetooth.service 2>/dev/null || true
          systemctl enable getty@tty1.service 2>/dev/null || true
          systemctl enable systemd-resolved.service 2>/dev/null || true

          for svc in feral-controld feral-sys-monitord feral-watchdog feral-setupd; do
            [ -f "/etc/systemd/system/${svc}.service" ] && systemctl enable "${svc}.service" 2>/dev/null || true
          done

          usermod -aG seat feralfile 2>/dev/null || true
          usermod -aG audio feralfile 2>/dev/null || true
          usermod -aG video feralfile 2>/dev/null || true
          usermod -aG input feralfile 2>/dev/null || true
          usermod -aG bluetooth feralfile 2>/dev/null || true

          cat > /home/feralfile/.bash_profile << 'BASHPROFILE'
          if [ "$(tty)" = "/dev/tty1" ]; then
              mkdir -p ~/.logs ~/.state
              echo "Waiting for user session..."
              for i in $(seq 1 30); do
                  [ -S "/run/user/$(id -u)/bus" ] && echo "D-Bus ready" && break
                  sleep 1
              done
              export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u)/bus"
              export XDG_RUNTIME_DIR="/run/user/$(id -u)"
              systemctl --user daemon-reload 2>/dev/null || true
              systemctl --user start feral-sys-monitord.service 2>/dev/null || true
              systemctl --user start aesthetic-kiosk.service 2>/dev/null || true
              echo "Aesthetic Computer OS booted."
          fi
          BASHPROFILE
          chown feralfile:feralfile /home/feralfile/.bash_profile

          echo "aesthetic-computer" > /etc/hostname
          echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
          locale-gen 2>/dev/null || true
          echo "LANG=en_US.UTF-8" > /etc/locale.conf

          echo "=== customize_airootfs.sh complete ==="
          CUSTOMIZE
          chmod +x "$PROFILE/airootfs/root/customize_airootfs.sh"

      - name: Setup pacman mirrors
        run: |
          curl -o /etc/pacman.d/mirrorlist "https://archlinux.org/mirrorlist/?country=US&protocol=https&ip_version=4&use_mirror_status=on"
          sed -i 's/^#Server/Server/' /etc/pacman.d/mirrorlist
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syy

          PROFILE=/work/archiso-profile
          mkdir -p "$PROFILE/pacman.d"
          cp /etc/pacman.d/mirrorlist "$PROFILE/pacman.d/mirrorlist"
          mkdir -p "$PROFILE/airootfs/etc/pacman.d"
          cp /etc/pacman.d/mirrorlist "$PROFILE/airootfs/etc/pacman.d/mirrorlist"

      - name: Build ISO
        run: |
          mkdir -p /work/out
          echo "=== Building ISO ==="
          mkarchiso -v -w /work/build -o /work/out /work/archiso-profile

      - name: Verify and compress ISO
        run: |
          VERSION="${{ inputs.version }}"
          cd /work/out

          ISO_FILE=$(find . -name "*.iso" | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "‚ùå No ISO file found!"
            exit 1
          fi

          ls -lh "$ISO_FILE"
          sha256sum "$ISO_FILE" | tee "${ISO_FILE}.sha256"

          # Verify SquashFS
          mkdir -p /tmp/iso-verify
          mount -o loop,ro "$ISO_FILE" /tmp/iso-verify
          if [ -f /tmp/iso-verify/arch/x86_64/airootfs.sfs ]; then
            unsquashfs -l /tmp/iso-verify/arch/x86_64/airootfs.sfs > /dev/null 2>&1 \
              && echo "‚úÖ SquashFS OK" \
              || { echo "‚ùå SquashFS CORRUPT"; umount /tmp/iso-verify; exit 1; }
          fi
          umount /tmp/iso-verify

          NEW_NAME="ac-os-${VERSION}.iso"
          mv "$ISO_FILE" "$NEW_NAME"
          zip -j "ac-os-${VERSION}.zip" "$NEW_NAME"
          ls -lh *.zip

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ac-os-${{ inputs.version }}
          path: /work/out/ac-os-*.zip
          retention-days: 14
          compression-level: 0
