name: Deploy Silo

on:
  push:
    branches: [main]
    paths:
      - "silo/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to silo server
        env:
          SSH_KEY: ${{ secrets.SILO_SSH_KEY }}
          SILO_ENV: ${{ secrets.SILO_ENV }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H silo.aesthetic.computer >> ~/.ssh/known_hosts 2>/dev/null

          # Upload silo files
          scp -i ~/.ssh/id_rsa \
            silo/server.mjs \
            silo/package.json \
            silo/package-lock.json \
            root@silo.aesthetic.computer:/opt/silo/

          # Write production .env
          echo "$SILO_ENV" | ssh -i ~/.ssh/id_rsa root@silo.aesthetic.computer "cat > /opt/silo/.env"

          # Fix ownership, install deps, restart
          ssh -i ~/.ssh/id_rsa root@silo.aesthetic.computer "
            chown -R silo:silo /opt/silo
            cd /opt/silo && npm install --production --silent
            systemctl restart silo
            sleep 2
            systemctl is-active silo
          "
