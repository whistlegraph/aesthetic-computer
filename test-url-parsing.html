<!DOCTYPE html>
<html>
<head>
    <title>Test URL Parsing</title>
</head>
<body>
    <h1>URL Parsing Test</h1>
    <div id="results"></div>
    
    <script>
        // Test the URL parsing functions with kidlisp URLs containing ?
        const testUrls = [
            'https://localhost:8888/fade:red-blue-black-blue-red§ink_(?_rainbow_white_0)_(1s..._24_64)§line_w/2_0_w/2_h§(spin_(2s..._-1_1))_(zoom_1.04)§(0.1s_(contrast_1.04))§(scroll_(?_-0.1_0_0.1)_(?_-0.1_0_0.1))',
            'https://localhost:8888/fade:red-blue-black-blue-red§ink_(?_rainbow_white_0)_(1s..._24_64)§line_w/2_0_w/2_h§(spin_(2s..._-1_1))_(zoom_1.04)§(0.1s_(contrast_1.04))§(scroll_(?_-0.1_0_0.1)_(?_-0.1_0_0.1))?nogap',
            'https://localhost:8888/fade:red-blue-black-blue-red§ink_(?_rainbow_white_0)_(1s..._24_64)§line_w/2_0_w/2_h§(spin_(2s..._-1_1))_(zoom_1.04)§(0.1s_(contrast_1.04))§(scroll_(?_-0.1_0_0.1)_(?_-0.1_0_0.1))?nolabel&zoom=1.5'
        ];
        
        // Copy the functions from boot.mjs
        const LEGITIMATE_PARAMS = [
            'icon', 'preview', 'signup', 'supportSignUp', 'success', 'code', 
            'supportForgotPassword', 'message', 'vscode', 'nogap', 'nolabel', 
            'density', 'zoom', 'duration', 'session-aesthetic', 'session-sotce', 'notice'
        ];

        function extractLegitimateParams(fullUrl) {
            const params = new URLSearchParams();
            
            for (const paramName of LEGITIMATE_PARAMS) {
                const regex = new RegExp(`[?&]${paramName}=([^&]*)`);
                const match = fullUrl.match(regex);
                if (match) {
                    params.set(paramName, decodeURIComponent(match[1]));
                }
                
                const boolRegex = new RegExp(`[?&]${paramName}(?=[&]|$)`);
                if (boolRegex.test(fullUrl)) {
                    params.set(paramName, 'true');
                }
            }
            
            return params;
        }

        function createCleanUrl(fullUrl) {
            let cleanUrl = fullUrl;
            
            for (const paramName of LEGITIMATE_PARAMS) {
                const regexWithValue = new RegExp(`[?&]${paramName}=([^&]*)`);
                const regexBool = new RegExp(`[?&]${paramName}(?=[&]|$)`);
                cleanUrl = cleanUrl.replace(regexWithValue, '');
                cleanUrl = cleanUrl.replace(regexBool, '');
            }
            
            cleanUrl = cleanUrl.replace(/[?&]+$/, '');
            
            return cleanUrl;
        }
        
        let results = '<h2>Test Results:</h2>';
        
        testUrls.forEach((url, index) => {
            const params = extractLegitimateParams(url);
            const cleanUrl = createCleanUrl(url);
            
            results += `<h3>Test ${index + 1}:</h3>`;
            results += `<p><strong>Original URL:</strong><br>${url}</p>`;
            results += `<p><strong>Clean URL (kidlisp preserved):</strong><br>${cleanUrl}</p>`;
            results += `<p><strong>Extracted Parameters:</strong></p><ul>`;
            
            params.forEach((value, key) => {
                results += `<li>${key}: ${value}</li>`;
            });
            
            if (params.size === 0) {
                results += '<li>No parameters found</li>';
            }
            
            results += '</ul><hr>';
        });
        
        document.getElementById('results').innerHTML = results;
    </script>
</body>
</html>
