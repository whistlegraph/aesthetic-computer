# Report: Welcome Pane All-Black in Dev Mode

**Date:** 2026-02-25  
**File:** `vscode-extension/extension.ts`

---

## TL;DR

The welcome pane goes all-black in dev mode because the embedded `<canvas>` has **no CSS width/height**, so it renders at 0×0 pixels. Combined with the dev server at `localhost:5555` not running (so the iframe fallback never activates), you get a completely black panel with nothing drawn.

---

## Root Cause 1 — Canvas Has No CSS Dimensions

**Location:** `extension.ts:1069`

```css
/* Current (broken) */
#canvas { position: absolute; top: 0; left: 0; }

/* dev.html standalone (working) */
#canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
```

The `process-tree-2d.js` canvas setup reads `clientWidth` / `clientHeight` to size the drawing surface:

```js
// process-tree-2d.js:66-71
function resizeCanvas() {
  width  = canvas.clientWidth;   // → 0 (no CSS dimensions)
  height = canvas.clientHeight;  // → 0
  canvas.width  = width  * dpr;  // → 0
  canvas.height = height * dpr;  // → 0
  ctx.scale(dpr, dpr);
}
resizeCanvas(); // runs immediately at load
```

With `clientWidth/Height = 0`, the canvas backing store is 0×0. Every `ctx.clearRect`, `ctx.fillRect`, `ctx.stroke`, etc. is a no-op against nothing. The body background color (`#181318` dark / `#fcf7c5` light) shows through — which in a VSCode dark theme reads as solid black.

The `dev.html` file that **does** work explicitly sets `width: 100%; height: 100%;` on `#canvas`. The embedded HTML template in `extension.ts` never got that fix.

---

## Root Cause 2 — Dev Iframe Fallback Never Activates

In dev mode the welcome pane is designed to:
1. Show the embedded canvas (process tree) immediately.
2. Poll `localhost:5555` every 2 seconds.
3. Once port 5555 responds, switch to a full-page `<iframe src="http://localhost:5555/dev.html">` that has the correct CSS.

**The issue:** port 5555 is a dedicated Vite/hot-reload dev server for the *extension's views*, separate from the main AC dev server on 8888. That server is almost certainly **not running** during a normal `npm run ac` session. So the poll always fails and the iframe never activates, leaving the broken embedded canvas visible indefinitely.

```ts
// extension.ts:870-896
async function checkWelcomeDevServer(): Promise<boolean> {
  // checks http://localhost:5555 with a HEAD request
  // silently returns false if not running
}
```

There is no user-visible indicator that the dev server is missing — the status badge just stays on `"embedded"`.

---

## Root Cause 3 — Three.js CDN Scripts Loaded But Unused

```html
<!-- extension.ts:1062-1063 — loaded on every welcome pane open -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/.../OrbitControls.js"></script>
```

The embedded pane was migrated from Three.js 3D to the 2D canvas renderer, but the Three.js script tags were left in. These:
- Waste ~600 KB of network load every time the panel opens.
- Can fail in Codespaces/offline environments, causing script errors that may interrupt the inline scripts that follow.
- The CSP allows `https://cdnjs.cloudflare.com` and `https://cdn.jsdelivr.net`, so they don't get blocked — they just load silently and do nothing.

---

## Summary Table

| # | Problem | Location | Effect |
|---|---------|----------|--------|
| 1 | `#canvas` missing `width: 100%; height: 100%` | `extension.ts:1069` | Canvas is 0×0, nothing renders |
| 2 | `localhost:5555` dev server not started | `extension.ts:865,900-924` | Iframe fallback never activates |
| 3 | Stale Three.js `<script>` tags from old 3D version | `extension.ts:1062-1063` | Unnecessary load, potential script errors |

---

## Fix

### 1. Add CSS dimensions to `#canvas` in the embedded template

```ts
// extension.ts:1069 — change:
#canvas { position: absolute; top: 0; left: 0; }
// to:
#canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
```

### 2. Remove the dead Three.js script tags

```ts
// extension.ts:1062-1063 — delete both lines:
<script src="https://cdnjs.cloudflare.com/...three.min.js"></script>
<script src="https://cdn.jsdelivr.net/.../OrbitControls.js"></script>
```

### 3. (Optional) Either start the port-5555 server or remove the dead dev-server polling

If `localhost:5555` is no longer the intended dev server for the extension views, the `checkWelcomeDevServer` / `startWelcomeDevServerCheck` / `WELCOME_DEV_URL` flow and the `#dev-frame` iframe injection can be removed or pointed at the correct URL.

---

*Generated by Claude Code — aesthetic-computer/vscode-extension*
