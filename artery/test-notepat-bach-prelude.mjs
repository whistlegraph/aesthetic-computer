#!/usr/bin/env node
/**
 * ðŸŽ» Bach Prelude (Cello Suite No. 1) - Notepat Test
 * 
 * Automatic notepat player for the full Prelude of BWV 1007.
 * Designed for artery-tui test runner (CDP/Electron compatible).
 * Source: http://www.jsbach.net/midi/midi_solo_cello.html (cs1-1pre.mid)
 * MIDI notes are transposed +19 semitones to fit notepat's keyboard range.
 *
 * Usage: node test-notepat-bach-prelude.mjs [bpm] [loop]
 */

import { getArtery } from './artery-auto.mjs';

// Colors
const PURPLE_BG = '\x1b[45m';
const WHITE = '\x1b[97m';
const RESET = '\x1b[0m';
const GREEN = '\x1b[92m';
const CYAN = '\x1b[96m';
const YELLOW = '\x1b[93m';

const testLog = (msg) => console.log(`${PURPLE_BG}${WHITE}ðŸ§ª${RESET} ${msg}`);
const successLog = (msg) => console.log(`${GREEN}âœ… ${msg}${RESET}`);
const playingLog = (msg) => console.log(`${YELLOW}ðŸŽµ ${msg}${RESET}`);

const sleep = (ms) => new Promise(r => setTimeout(r, ms));

// Notepat key mapping (labels -> qwerty keys)
const LABEL_TO_KEY = {
  '-a': 'control',
  '-a#': 'z',
  '-b': 'x',
  c: 'c',
  'c#': 'v',
  d: 'd',
  'd#': 's',
  e: 'e',
  f: 'f',
  'f#': 'w',
  g: 'g',
  'g#': 'r',
  a: 'a',
  'a#': 'q',
  b: 'b',
  '+c': 'h',
  '+c#': 't',
  '+d': 'i',
  '+d#': 'y',
  '+e': 'j',
  '+f': 'k',
  '+f#': 'u',
  '+g': 'l',
  '+g#': 'o',
  '+a': 'm',
  '+a#': 'p',
  '+b': 'n',
  '++c': ';',
  '++c#': "'",
  '++d': ']',
};

const KEY_EVENT_OVERRIDES = {
  control: { key: 'Control', code: 'ControlLeft', keyCode: 17 },
  ';': { key: ';', code: 'Semicolon', keyCode: 186 },
  "'": { key: "'", code: 'Quote', keyCode: 222 },
  ']': { key: ']', code: 'BracketRight', keyCode: 221 },
};

function labelToKey(label) {
  return LABEL_TO_KEY[label] ?? null;
}

const MIDI_TICKS_PER_BEAT = 480;
const MIDI_DEFAULT_BPM = 77;
const MIDI_EVENTS = [
  { key: "d", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "-b", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "-b", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "-b", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a#", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a#", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a#", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a#", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "c#", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "c#", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "c#", ticks: 120 },
  { key: "-b", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "-a#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "-a#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+a", ticks: 360 },
  { key: "e", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+a#", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "-a", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f", ticks: 120 },
  { key: "+f", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g#", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "d", ticks: 120 },
  { key: "c#", ticks: 120 },
  { key: "-b", ticks: 120 },
  { key: "-a", ticks: 240 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "g", ticks: 120 },
  { key: "f#", ticks: 120 },
  { key: "e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 0 },
  { key: null, ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "b", ticks: 120 },
  { key: "+c", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+c#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+d#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+g#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+a", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+a#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+b", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "++c", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+f#", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++d", ticks: 120 },
  { key: "+e", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "a", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "++c#", ticks: 120 },
  { key: "+g", ticks: 120 },
  { key: "d", ticks: 1920 },
  { key: "+f#", ticks: 1920 },
  { key: "++d", ticks: 1920 },
];

async function pressKey(client, key) {
  const override = KEY_EVENT_OVERRIDES[key];
  const keyValue = override?.key ?? key;
  const code = override?.code ?? `Key${key.toUpperCase()}`;
  const keyCode = override?.keyCode ?? key.toUpperCase().charCodeAt(0);
  await client.send('Input.dispatchKeyEvent', {
    type: 'keyDown',
    text: keyValue,
    key: keyValue,
    code,
    windowsVirtualKeyCode: keyCode,
  });
}

async function releaseKey(client, key) {
  const override = KEY_EVENT_OVERRIDES[key];
  const keyValue = override?.key ?? key;
  const code = override?.code ?? `Key${key.toUpperCase()}`;
  const keyCode = override?.keyCode ?? key.toUpperCase().charCodeAt(0);
  await client.send('Input.dispatchKeyEvent', {
    type: 'keyUp',
    key: keyValue,
    code,
    windowsVirtualKeyCode: keyCode,
  });
}

async function playEvent(client, event, msPerTick) {
  if (!event || event.ticks <= 0) return false;
  const durationMs = Math.max(10, Math.round(event.ticks * msPerTick));
  if (!event.key) {
    await sleep(durationMs);
    return false;
  }
  const key = labelToKey(event.key);
  if (!key) {
    await sleep(durationMs);
    return false;
  }
  const hold = Math.max(40, Math.floor(durationMs * 0.7));
  const gap = Math.max(5, durationMs - hold);
  await pressKey(client, key);
  await sleep(hold);
  await releaseKey(client, key);
  await sleep(gap);
  return true;
}

function parseArgs() {
  const args = process.argv.slice(2);
  let bpm = MIDI_DEFAULT_BPM;
  let loop = false;
  for (const arg of args) {
    if (arg === 'loop') loop = true;
    const maybeNumber = Number(arg);
    if (!Number.isNaN(maybeNumber) && maybeNumber > 0) bpm = maybeNumber;
  }
  return { bpm, loop };
}

async function main() {
  const { bpm, loop } = parseArgs();
  const msPerTick = (60000 / bpm) / MIDI_TICKS_PER_BEAT;
  const totalNotes = MIDI_EVENTS.filter((event) => event.key).length;

  testLog('Bach Prelude (Cello Suite No. 1) - Notepat Test');
  playingLog(`Full Prelude Â· ${bpm} BPM Â· ${totalNotes} notes${loop ? ' Â· LOOP' : ''}`);

  try {
    const Artery = await getArtery();

    await Artery.openPanelStandalone();
    await sleep(500);

    const client = new Artery();
    await client.connect();
    testLog('Connected');

    await client.jump('notepat');
    testLog('Navigated to notepat');
    await sleep(2000);

    await client.activateAudio();
    testLog('Audio activated');
    await sleep(500);

    let run = 0;
    do {
      run += 1;
      console.log(`\n${CYAN}â€” Prelude pass ${run} â€”${RESET}\n`);
      let played = 0;

      for (const event of MIDI_EVENTS) {
        const playedNote = await playEvent(client, event, msPerTick);
        if (playedNote) {
          process.stdout.write(`${YELLOW}â™ª${RESET}`);
          played++;
          if (played % 16 === 0) console.log('');
        }
      }

      console.log('');
      successLog(`Pass ${run} complete (${played} notes)`);
      await sleep(600);
    } while (loop);

    await client.jump('prompt');
    testLog('Returned to prompt');
    await sleep(500);
    client.close();
    await Artery.closePanelStandalone();

    successLog('Test complete!');
    process.exit(0);
  } catch (err) {
    console.error(`\n${YELLOW}Error:${RESET}`, err.message);
    process.exit(1);
  }
}

main();